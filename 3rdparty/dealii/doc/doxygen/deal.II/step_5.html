<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>The deal.II Library: The step-5 tutorial program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="http://www.dealii.org/deal.ico"></link>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2014 by the deal.II authors"></meta>
<meta name="deal.II-version" content="8.1.0"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 8.1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">The step-5 tutorial program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a>
        <li><a href="#ThecodeStep5codeclasstemplate">The <code>Step5</code> class template</a>
        <li><a href="#NonconstantcoefficientsusingcodeAssertcode">Nonconstant coefficients, using <code>Assert</code></a>
        <li><a href="#ThecodeStep5codeclassimplementation">The <code>Step5</code> class implementation</a>
      <ul>
        <li><a href="#Step5Step5">Step5::Step5</a>
        <li><a href="#Step5setup_system">Step5::setup_system</a>
        <li><a href="#Step5assemble_system">Step5::assemble_system</a>
        <li><a href="#Step5solve">Step5::solve</a>
        <li><a href="#Step5output_resultsandsettingoutputflags">Step5::output_results and setting output flags</a>
        <li><a href="#Step5run">Step5::run</a>
      </ul>
        <li><a href="#Thecodemaincodefunction">The <code>main</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p>
<h1>Introduction</h1>
<p>This example does not show revolutionary new things, but it shows many small improvements over the previous examples, and also many small things that can usually be found in finite element programs. Among them are: </p>
<ul>
<li>
Computations on successively refined grids. At least in the mathematical sciences, it is common to compute solutions on a hierarchy of grids, in order to get a feeling for the accuracy of the solution; if you only have one solution on a single grid, you usually can't guess the accuracy of the solution. Furthermore, deal.II is designed to support adaptive algorithms where iterative solution on successively refined grids is at the heart of algorithms. Although adaptive grids are not used in this example, the foundations for them is laid here. </li>
<li>
In practical applications, the domains are often subdivided into triangulations by automatic mesh generators. In order to use them, it is important to read coarse grids from a file. In this example, we will read a coarse grid in UCD (unstructured cell data) format as used by AVS Explorer. </li>
<li>
Finite element programs usually use extensive amounts of computing time, so some optimizations are sometimes necessary. We will show some of them. </li>
<li>
On the other hand, finite element programs tend to be rather complex, so debugging is an important aspect. We support safe programming by using assertions that check the validity of parameters and internal states in a debug mode, but are removed in optimized mode. </li>
<li>
Regarding the mathematical side, we show how to support a variable coefficient in the elliptic operator and how to use preconditioned iterative solvers for the linear systems of equations. </li>
</ul>
<p>The equation to solve here is as follows: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{align*} -\nabla \cdot a(\mathbf x) \nabla u(\mathbf x) &amp;= 1 \qquad\qquad &amp; \text{in}\ \Omega, \\ u &amp;= 0 \qquad\qquad &amp; \text{on}\ \partial\Omega. \end{align*}" src="form_1780.png"/>
</p>
<p> If <img class="formulaInl" alt="$a(\mathbf x)$" src="form_1781.png"/> was a constant coefficient, this would simply be the Poisson equation. However, if it is indeed spatially variable, it is a more complex equation (often referred to as the "extended Poisson equation"). Depending on what the variable <img class="formulaInl" alt="$u$" src="form_594.png"/> refers to it models a variety of situations with wide applicability:</p>
<ul>
<li>If <img class="formulaInl" alt="$u$" src="form_594.png"/> is the electric potential, then <img class="formulaInl" alt="$-a\nabla u$" src="form_1782.png"/> is the electric current in a medium and the coefficient <img class="formulaInl" alt="$a$" src="form_399.png"/> is the conductivity of the medium at any given point. (In this situation, the right hand side of the equation would be the electric source density and would usually be zero or consist of localized, Delta-like, functions.)</li>
<li>If <img class="formulaInl" alt="$u$" src="form_594.png"/> is the vertical deflection of a thin membrane, then <img class="formulaInl" alt="$a$" src="form_399.png"/> would be a measure of the local stiffness. This is the interpretation that will allow us to interpret the images shown in the results section below.</li>
</ul>
<p>Since the Laplace/Poisson equation appears in so many contexts, there are many more interpretations than just the two listed above.</p>
<p>When assembling the linear system for this equation, we need the weak form which here reads as follows: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{align*} (a \nabla \varphi, \nabla u) &amp;= (\varphi, 1) \qquad \qquad \forall \varphi. \end{align*}" src="form_1783.png"/>
</p>
<p> The implementation in the <code>assemble_system</code> function follows immediately from this. <a class="anchor" id="CommProg"></a> </p>
<h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p>
<h3>Include files</h3>
<p>Again, the first few include files are already known, so we won't comment on them:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;deal.II/base/quadrature_lib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/base/function.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/base/logstream.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/vector.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/full_matrix.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/sparse_matrix.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/compressed_sparsity_pattern.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/solver_cg.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/precondition.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_handler.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria_accessor.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria_iterator.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_accessor.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_tools.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/fe/fe_q.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/fe/fe_values.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/vector_tools.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/matrix_tools.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/data_out.h&gt;</span></div>
</div><!-- fragment --><p>This one is new. We want to read a triangulation from disk, and the class which does this is declared in the following file :</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;deal.II/grid/grid_in.h&gt;</span></div>
</div><!-- fragment --><p>We will use a circular domain, and the object describing the boundary of it comes from this file :</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria_boundary_lib.h&gt;</span></div>
</div><!-- fragment --><p>This is C++ ...</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
</div><!-- fragment --><p>... and this is too: We will convert integers to strings using the C++ stringstream class <code>ostringstream</code>:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;sstream&gt;</span></div>
</div><!-- fragment --><p>Finally, this has been discussed in previous tutorial programs before:</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span>dealii;</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeStep5codeclasstemplate"></a> </p>
<h3>The <code>Step5</code> class template</h3>
<p>The main class is mostly as in the previous example. The most visible change is that the function <code>make_grid_and_dofs</code> has been removed, since creating the grid is now done in the <code>run</code> function and the rest of its functionality is now in <code>setup_system</code>. Apart from this, everything is as before.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>Step5</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  Step5 ();</div>
<div class="line">  <span class="keywordtype">void</span> run ();</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> setup_system ();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_system ();</div>
<div class="line">  <span class="keywordtype">void</span> solve ();</div>
<div class="line">  <span class="keywordtype">void</span> output_results (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle) <span class="keyword">const</span>;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>   triangulation;</div>
<div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>            fe;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>      dof_handler;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern;</div>
<div class="line">  <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>       solution;</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>       system_rhs;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="NonconstantcoefficientsusingcodeAssertcode"></a> </p>
<h3>Nonconstant coefficients, using <code>Assert</code></h3>
<p>In <a class="el" href="step_4.html">step-4</a>, we showed how to use non-constant boundary values and right hand side. In this example, we want to use a variable coefficient in the elliptic operator instead. Of course, the suitable object is a <code><a class="el" href="classFunction.html">Function</a></code>, as we have used for the right hand side and boundary values in the last example. We will use it again, but we implement another function <code>value_list</code> which takes a list of points and returns the values of the function at these points as a list. The reason why such a function is reasonable although we can get all the information from the <code>value</code> function as well will be explained below when assembling the matrix.</p>
<p>The need to declare a seemingly useless default constructor exists here just as in the previous example.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>Coefficient : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  Coefficient ()  : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;() {}</div>
<div class="line"></div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#a9783cc12b6b205d4019379b0cc6f3956">value</a> (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>   &amp;p,</div>
<div class="line">                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  component = 0) <span class="keyword">const</span>;</div>
<div class="line"></div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classFunction.html#af6f1aceeeb499ff07d828df250f4f3b2">value_list</a> (<span class="keyword">const</span> std::vector&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &gt; &amp;points,</div>
<div class="line">                           std::vector&lt;double&gt;            &amp;values,</div>
<div class="line">                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>              component = 0) <span class="keyword">const</span>;</div>
<div class="line">};</div>
</div><!-- fragment --><p>This is the implementation of the coefficient function for a single point. We let it return 20 if the distance to the origin is less than 0.5, and 1 otherwise. As in the previous example, we simply ignore the second parameter of the function that is used to denote different components of vector-valued functions (we deal only with a scalar function here, after all):</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> Coefficient&lt;dim&gt;::value (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div>
<div class="line">                                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> / *component* /)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">if</span> (p.<a class="code" href="classPoint.html#ad46f55479010282e242b1d8e427285e8">square</a>() &lt; 0.5*0.5)</div>
<div class="line">    <span class="keywordflow">return</span> 20;</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
</div><!-- fragment --><p>And this is the function that returns the value of the coefficient at a whole list of points at once. Of course, we need to make sure that the values are the same as if we would ask the <code>value</code> function for each point individually.</p>
<p>This method takes three parameters: a list of points at which to evaluate the function, a list that will hold the values at these points, and the vector component that should be zero here since we only have a single scalar function. Now, of course the size of the output array (<code>values</code>) must be the same as that of the input array (<code>points</code>), and we could simply assume that. However, in practice, it turns out that more than 90 per cent of programming errors are invalid function parameters such as invalid array sizes, etc, so we should try to make sure that the parameters are valid. For this, the <code>Assert</code> macro is a good means, since it makes sure that the condition which is given as first argument is valid, and if not throws an exception (its second argument) which will usually terminate the program giving information where the error occurred and what the reason was. This generally reduces the time to find programming errors dramatically and we have found assertions an invaluable means to program fast.</p>
<p>On the other hand, all these checks (there are more than 4200 of them in the library at present) should not slow down the program too much if you want to do large computations. To this end, the <code>Assert</code> macro is only used in debug mode and expands to nothing if in optimized mode. Therefore, while you test your program on small problems and debug it, the assertions will tell you where the problems are. Once your program is stable, you can switch off debugging and the program will run your real computations without the assertions and at maximum speed. (In fact, it turns out the switching off all the checks in the library that prevent you from calling functions with the wrong arguments by switching to optimized mode, makes most programs run faster by about a factor of four. This should, however, not try to induce you to always run in optimized mode: Most people who have tried that soon realize that they introduce lots of errors that would have easily been caught had they run the program in debug mode while developing.) For those who want to try: The way to switch from debug mode to optimized mode is to go edit the Makefile in this directory. It should have a line <code>debug-mode = on</code>; simply replace it by <code>debug-mode = off</code> and recompile your program. The output of the <code>make</code> program should already indicate to you that the program is now compiled in optimized mode, and it will later also be linked to libraries that have been compiled for optimized mode.</p>
<p>Here, as has been said above, we would like to make sure that the size of the two arrays is equal, and if not throw an exception. Comparing the sizes of two arrays is one of the most frequent checks, which is why there is already an exception class <code>ExcDimensionMismatch</code> that takes the sizes of two vectors and prints some output in case the condition is violated:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Coefficient&lt;dim&gt;::value_list (<span class="keyword">const</span> std::vector&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &gt; &amp;points,</div>
<div class="line">                                   std::vector&lt;double&gt;            &amp;values,</div>
<div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>              component)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a> (values.size() == points.size(),</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga325fd73751a9373f1b901962daeb2ea7">ExcDimensionMismatch</a> (values.size(), points.size()));</div>
</div><!-- fragment --><p>Since examples are not very good if they do not demonstrate their point, we will show how to trigger this exception at the end of the main program, and what output results from this (see the <code>Results</code> section of this example program). You will certainly notice that the output is quite well suited to quickly find what the problem is and what parameters are expected. An additional plus is that if the program is run inside a debugger, it will stop at the point where the exception is triggered, so you can go up the call stack to immediately find the place where the the array with the wrong size was set up.</p>
<p>While we're at it, we can do another check: the coefficient is a scalar, but the <code><a class="el" href="classFunction.html">Function</a></code> class also represents vector-valued function. A scalar function must therefore be considered as a vector-valued function with only one component, so the only valid component for which a user might ask is zero (we always count from zero). The following assertion checks this. If the condition in the <code>Assert</code> call is violated, an exception of type <code>ExcRange</code> will be triggered; that class takes the violating index as first argument, and the second and third arguments denote a range that includes the left point but is open at the right, i.e. here the interval [0,1). For integer arguments, this means that the only value in the range is the zero, of course. (The interval is half open since we also want to write exceptions like <code>ExcRange(i,0,v.size())</code>, where an index must be between zero but less than the size of an array. To save us the effort of writing <code>v.size()-1</code> in many places, the range is defined as half-open.)</p>
<div class="fragment"><div class="line"><a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a> (component == 0,</div>
<div class="line">        <a class="code" href="group__Exceptions.html#ga3f3f87a5613ac8b4e64ecd458dea8e9b">ExcIndexRange</a> (component, 0, 1));</div>
</div><!-- fragment --><p>The rest of the function is uneventful: we define <code>n_q_points</code> as an abbreviation for the number of points for which function values are requested, and then simply fill the output value:</p>
<div class="fragment"><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_points = points.size();</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;n_points; ++i)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (points[i].square() &lt; 0.5*0.5)</div>
<div class="line">        values[i] = 20;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        values[i] = 1;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeStep5codeclassimplementation"></a> </p>
<h3>The <code>Step5</code> class implementation</h3>
<p><a class="anchor" id="Step5Step5"></a> </p>
<h4>Step5::Step5</h4>
<p>This function is as before.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">Step5&lt;dim&gt;::Step5 () :</div>
<div class="line">  fe (1),</div>
<div class="line">  dof_handler (triangulation)</div>
<div class="line">{}</div>
</div><!-- fragment --><p><a class="anchor" id="Step5setup_system"></a> </p>
<h4>Step5::setup_system</h4>
<p>This is the function <code>make_grid_and_dofs</code> from the previous example, minus the generation of the grid. Everything else is unchanged:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step5&lt;dim&gt;::setup_system ()</div>
<div class="line">{</div>
<div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#afcfcc3b473f444f50d206ae62dfe3694">distribute_dofs</a> (fe);</div>
<div class="line"></div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span></div>
<div class="line">            &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#a54e7270f2ba6206604f794114b39a2aa">n_dofs</a>()</div>
<div class="line">            &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classCompressedSparsityPattern.html">CompressedSparsityPattern</a> c_sparsity(dof_handler.<a class="code" href="classDoFHandler.html#a54e7270f2ba6206604f794114b39a2aa">n_dofs</a>());</div>
<div class="line">  <a class="code" href="group__constraints.html#gab627b1d4845c9526521dbd1be83469dc">DoFTools::make_sparsity_pattern</a> (dof_handler, c_sparsity);</div>
<div class="line">  sparsity_pattern.<a class="code" href="classSparsityPattern.html#aafd93c00be64a9ab832c68aefaecace6">copy_from</a>(c_sparsity);</div>
<div class="line"></div>
<div class="line">  system_matrix.reinit (sparsity_pattern);</div>
<div class="line"></div>
<div class="line">  solution.<a class="code" href="classVector.html#ac3adfcf8cf35943558fc27ef989b7263">reinit</a> (dof_handler.<a class="code" href="classDoFHandler.html#a54e7270f2ba6206604f794114b39a2aa">n_dofs</a>());</div>
<div class="line">  system_rhs.reinit (dof_handler.<a class="code" href="classDoFHandler.html#a54e7270f2ba6206604f794114b39a2aa">n_dofs</a>());</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Step5assemble_system"></a> </p>
<h4>Step5::assemble_system</h4>
<p>As in the previous examples, this function is not changed much with regard to its functionality, but there are still some optimizations which we will show. For this, it is important to note that if efficient solvers are used (such as the preconditions CG method), assembling the matrix and right hand side can take a comparable time, and you should think about using one or two optimizations at some places.</p>
<p>What we will show here is how we can avoid calls to the shape_value, shape_grad, and quadrature_point functions of the <a class="el" href="classFEValues.html">FEValues</a> object, and in particular optimize away most of the virtual function calls of the <a class="el" href="classFunction.html">Function</a> object. The way to do so will be explained in the following, while those parts of this function that are not changed with respect to the previous example are not commented on.</p>
<p>The first parts of the function are completely unchanged from before:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step5&lt;dim&gt;::assemble_system ()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(2);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values (fe, quadrature_formula,</div>
<div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>    |  <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>  |  <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"></div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#a4d64837b1d374e9c46f07af8f094b29b">size</a>();</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>   cell_matrix (dofs_per_cell, dofs_per_cell);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>       cell_rhs (dofs_per_cell);</div>
<div class="line"></div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; local_dof_indices (dofs_per_cell);</div>
</div><!-- fragment --><p>Here is one difference: for this program, we will again use a constant right hand side function and zero boundary values, but a variable coefficient. We have already declared the class that represents this coefficient above, so we only have to declare a corresponding object here.</p>
<p>Then, below, we will ask the <code>coefficient</code> function object to compute the values of the coefficient at all quadrature points on one cell at once. The reason for this is that, if you look back at how we did this in <a class="el" href="step_4.html">step-4</a>, you will realize that we called the function computing the right hand side value inside nested loops over all degrees of freedom and over all quadrature points, i.e. dofs_per_cell*n_q_points times. For the coefficient that is used inside the matrix, this would actually be dofs_per_cell*dofs_per_cell*n_q_points. On the other hand, the function will of course return the same value every time it is called with the same quadrature point, independently of what shape function we presently treat; secondly, these are virtual function calls, so are rather expensive. Obviously, there are only n_q_point different values, and we shouldn't call the function more often than that. Or, even better than this, compute all of these values at once, and get away with a single function call per cell.</p>
<p>This is exactly what we are going to do. For this, we need some space to store the values in. We therefore also have to declare an array to hold these values:</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> Coefficient&lt;dim&gt; coefficient;</div>
<div class="line">std::vector&lt;double&gt;    coefficient_values (n_q_points);</div>
</div><!-- fragment --><p>Next is the typical loop over all cells to compute local contributions and then to transfer them into the global matrix and vector.</p>
<p>The only two things in which this loop differs from <a class="el" href="step_4.html">step-4</a> is that we want to compute the value of the coefficient in all quadrature points on the present cell at the beginning, and then use it in the computation of the local contributions. This is what we do in the call to <code>coefficient.value_list</code> in the fourth line of the loop.</p>
<p>The second change is how we make use of this coefficient in computing the cell matrix contributions. This is in the obvious way, and not worth more comments. For the right hand side, we use a constant value again.</p>
<div class="fragment"><div class="line"><span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a></div>
<div class="line">cell = dof_handler.<a class="code" href="classDoFHandler.html#a6f2aa9c61385cbb749ed3d2e7bfe3de1">begin_active</a>(),</div>
<div class="line">endc = dof_handler.<a class="code" href="classDoFHandler.html#abf64c3734383b6fb1bed4888935f2edf">end</a>();</div>
<div class="line"><span class="keywordflow">for</span> (; cell!=endc; ++cell)</div>
<div class="line">  {</div>
<div class="line">    cell_matrix = 0;</div>
<div class="line">    cell_rhs = 0;</div>
<div class="line"></div>
<div class="line">    fe_values.<a class="code" href="classFEValues.html#afde502903642c57ade24dfcebf5c1650">reinit</a> (cell);</div>
<div class="line"></div>
<div class="line">    coefficient.value_list (fe_values.<a class="code" href="classFEValuesBase.html#a5f8732ebe2d3c6746f6de26a79cb1e45">get_quadrature_points</a>(),</div>
<div class="line">                            coefficient_values);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point=0; q_point&lt;n_q_points; ++q_point)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;dofs_per_cell; ++i)</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j=0; j&lt;dofs_per_cell; ++j)</div>
<div class="line">            cell_matrix(i,j) += (coefficient_values[q_point] *</div>
<div class="line">                                 fe_values.<a class="code" href="classFEValuesBase.html#ac4cee7628c2903a89c5c399fddeb00a5">shape_grad</a>(i,q_point) *</div>
<div class="line">                                 fe_values.<a class="code" href="classFEValuesBase.html#ac4cee7628c2903a89c5c399fddeb00a5">shape_grad</a>(j,q_point) *</div>
<div class="line">                                 fe_values.<a class="code" href="classFEValuesBase.html#ad097580a2f71878695096cc73b271b9d">JxW</a>(q_point));</div>
<div class="line"></div>
<div class="line">          cell_rhs(i) += (fe_values.<a class="code" href="classFEValuesBase.html#abe4de48ff59778bb82a0ec13037804aa">shape_value</a>(i,q_point) *</div>
<div class="line">                          1.0 *</div>
<div class="line">                          fe_values.<a class="code" href="classFEValuesBase.html#ad097580a2f71878695096cc73b271b9d">JxW</a>(q_point));</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    cell-&gt;get_dof_indices (local_dof_indices);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;dofs_per_cell; ++i)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j=0; j&lt;dofs_per_cell; ++j)</div>
<div class="line">          system_matrix.add (local_dof_indices[i],</div>
<div class="line">                             local_dof_indices[j],</div>
<div class="line">                             cell_matrix(i,j));</div>
<div class="line"></div>
<div class="line">        system_rhs(local_dof_indices[i]) += cell_rhs(i);</div>
<div class="line">      }</div>
<div class="line">  }</div>
</div><!-- fragment --><p>With the matrix so built, we use zero boundary values again:</p>
<div class="fragment"><div class="line">  std::map&lt;types::global_dof_index,double&gt; boundary_values;</div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#a199f38e07822b47e5b5957c21ce35d1b">VectorTools::interpolate_boundary_values</a> (dof_handler,</div>
<div class="line">                                            0,</div>
<div class="line">                                            <a class="code" href="classZeroFunction.html">ZeroFunction&lt;dim&gt;</a>(),</div>
<div class="line">                                            boundary_values);</div>
<div class="line">  <a class="code" href="namespaceMatrixTools.html#a41a069894610445f84840d712d4f891e">MatrixTools::apply_boundary_values</a> (boundary_values,</div>
<div class="line">                                      system_matrix,</div>
<div class="line">                                      solution,</div>
<div class="line">                                      system_rhs);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Step5solve"></a> </p>
<h4>Step5::solve</h4>
<p>The solution process again looks mostly like in the previous examples. However, we will now use a preconditioned conjugate gradient algorithm. It is not very difficult to make this change. In fact, the only thing we have to alter is that we need an object which will act as a preconditioner. We will use SSOR (symmetric successive overrelaxation), with a relaxation factor of 1.2. For this purpose, the <code><a class="el" href="classSparseMatrix.html">SparseMatrix</a></code> class has a function which does one SSOR step, and we need to package the address of this function together with the matrix on which it should act (which is the matrix to be inverted) and the relaxation factor into one object. The <code><a class="el" href="classPreconditionSSOR.html">PreconditionSSOR</a></code> class does this for us. (<code><a class="el" href="classPreconditionSSOR.html">PreconditionSSOR</a></code> class takes a template argument denoting the matrix type it is supposed to work on. The default value is <code><a class="el" href="classSparseMatrix.html">SparseMatrix</a>&lt;double&gt;</code>, which is exactly what we need here, so we simply stick with the default and do not specify anything in the angle brackets.)</p>
<p>Note that for the present case, SSOR doesn't really perform much better than most other preconditioners (though better than no preconditioning at all). A brief comparison of different preconditioners is presented in the Results section of the next tutorial program, <a class="el" href="step_6.html">step-6</a>.</p>
<p>With this, the rest of the function is trivial: instead of the <code><a class="el" href="classPreconditionIdentity.html">PreconditionIdentity</a></code> object we have created before, we now use the preconditioner we have declared, and the CG solver will do the rest for us:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step5&lt;dim&gt;::solve ()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a>           solver_control (1000, 1e-12);</div>
<div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;&gt;</a>              solver (solver_control);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;&gt;</a> preconditioner;</div>
<div class="line">  preconditioner.<a class="code" href="classPreconditionSSOR.html#aa564d2dbcdcf09c6ceed549f319b5465">initialize</a>(system_matrix, 1.2);</div>
<div class="line"></div>
<div class="line">  solver.solve (system_matrix, solution, system_rhs,</div>
<div class="line">                preconditioner);</div>
<div class="line"></div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot; CG iterations needed to obtain convergence.&quot;</span></div>
<div class="line">            &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Step5output_resultsandsettingoutputflags"></a> </p>
<h4>Step5::output_results and setting output flags</h4>
<p>Writing output to a file is mostly the same as for the previous example, but here we will show how to modify some output options and how to construct a different filename for each refinement cycle.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step5&lt;dim&gt;::output_results (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line"></div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a5e63bad650805ce93cd74c6dc3b29b11">attach_dof_handler</a> (dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a59a6b70a4b909e0229a20487dd68cc43">add_data_vector</a> (solution, <span class="stringliteral">&quot;solution&quot;</span>);</div>
<div class="line"></div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#ab3d44201acb97fba286a897452236b51">build_patches</a> ();</div>
</div><!-- fragment --><p>For this example, we would like to write the output directly to a file in Encapsulated Postscript (EPS) format. The library supports this, but things may be a bit more difficult sometimes, since EPS is a printing format, unlike most other supported formats which serve as input for graphical tools. Therefore, you can't scale or rotate the image after it has been written to disk, and you have to decide about the viewpoint or the scaling in advance.</p>
<p>The defaults in the library are usually quite reasonable, and regarding viewpoint and scaling they coincide with the defaults of Gnuplot. However, since this is a tutorial, we will demonstrate how to change them. For this, we first have to generate an object describing the flags for EPS output (similar flag classes exist for all supported output formats):</p>
<div class="fragment"><div class="line"><a class="code" href="structDataOutBase_1_1EpsFlags.html">DataOutBase::EpsFlags</a> eps_flags;</div>
</div><!-- fragment --><p>They are initialized with the default values, so we only have to change those that we don't like. For example, we would like to scale the z-axis differently (stretch each data point in z-direction by a factor of four):</p>
<div class="fragment"><div class="line">eps_flags.<a class="code" href="structDataOutBase_1_1EpsFlags.html#aae56c32425575726b67b106edef3787b">z_scaling</a> = 4;</div>
</div><!-- fragment --><p>Then we would also like to alter the viewpoint from which we look at the solution surface. The default is at an angle of 60 degrees down from the vertical axis, and 30 degrees rotated against it in mathematical positive sense. We raise our viewpoint a bit and look more along the y-axis:</p>
<div class="fragment"><div class="line">eps_flags.<a class="code" href="structDataOutBase_1_1EpsFlags.html#afb565808367b204a1abbc5ecdf68278b">azimut_angle</a> = 40;</div>
<div class="line">eps_flags.<a class="code" href="structDataOutBase_1_1EpsFlags.html#a3afae76795cf33c76a3f65af902abf41">turn_angle</a>   = 10;</div>
</div><!-- fragment --><p>That shall suffice. There are more flags, for example whether to draw the mesh lines, which data vectors to use for colorization of the interior of the cells, and so on. You may want to take a look at the documentation of the EpsFlags structure to get an overview of what is possible.</p>
<p>The only thing still to be done, is to tell the output object to use these flags:</p>
<div class="fragment"><div class="line">data_out.<a class="code" href="classDataOutInterface.html#ab62747d458c1415d4bdb5e5b0ea2a68f">set_flags</a> (eps_flags);</div>
</div><!-- fragment --><p>The above way to modify flags requires recompilation each time we would like to use different flags. This is inconvenient, and we will see more advanced ways in <a class="el" href="step_19.html">step-19</a> where the output flags are determined at run time using an input file (<a class="el" href="step_19.html">step-19</a> doesn't show many other things; you should feel free to read over it even if you haven't done <a class="el" href="step_6.html">step-6</a> to <a class="el" href="step_18.html">step-18</a> yet).</p>
<p>Finally, we need the filename to which the results are to be written. We would like to have it of the form <code>solution-N.eps</code>, where N is the number of the refinement cycle. Thus, we have to convert an integer to a part of a string; this can be done using the <code>sprintf</code> function, but in C++ there is a more elegant way: write everything into a special stream (just like writing into a file or to the screen) and retrieve what you wrote as a string. This applies the usual conversions from integer to strings, and one could as well use stream modifiers such as <code>setw</code>, <code>setprecision</code>, and so on. In C++, you can do this by using the so-called stringstream classes:</p>
<div class="fragment"><div class="line">std::ostringstream filename;</div>
</div><!-- fragment --><p>In order to now actually generate a filename, we fill the stringstream variable with the base of the filename, then the number part, and finally the suffix indicating the file type:</p>
<div class="fragment"><div class="line">filename &lt;&lt; <span class="stringliteral">&quot;solution-&quot;</span></div>
<div class="line">         &lt;&lt; cycle</div>
<div class="line">         &lt;&lt; <span class="stringliteral">&quot;.eps&quot;</span>;</div>
</div><!-- fragment --><p>We can get whatever we wrote to the stream using the <code>str()</code> function. The result is a string which we have to convert to a char* using the <code>c_str()</code> function. Use that as filename for the output stream and then write the data to the file :</p>
<div class="fragment"><div class="line">  std::ofstream output (filename.str().c_str());</div>
<div class="line"></div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#a16609dff8ed26b761521930933679b7e">write_eps</a> (output);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Step5run"></a> </p>
<h4>Step5::run</h4>
<p>The second to last thing in this program is the definition of the <code>run()</code> function. In contrast to the previous programs, we will compute on a sequence of meshes that after each iteration is globally refined. The function therefore consists of a loop over 6 cycles. In each cycle, we first print the cycle number, and then have to decide what to do with the mesh. If this is not the first cycle, we simply refine the existing mesh once globally. Before running through these cycles, however, we have to generate a mesh:</p>
<p>In previous examples, we have already used some of the functions from the <code><a class="el" href="namespaceGridGenerator.html">GridGenerator</a></code> class. Here we would like to read a grid from a file where the cells are stored and which may originate from someone else, or may be the product of a mesh generator tool.</p>
<p>In order to read a grid from a file, we generate an object of data type <a class="el" href="classGridIn.html">GridIn</a> and associate the triangulation to it (i.e. we tell it to fill our triangulation object when we ask it to read the file). Then we open the respective file and initialize the triangulation with the data in the file :</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step5&lt;dim&gt;::run ()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classGridIn.html">GridIn&lt;dim&gt;</a> grid_in;</div>
<div class="line">  grid_in.<a class="code" href="classGridIn.html#a82ac1c03b0efe87204ad45d2f1d87f7e">attach_triangulation</a> (triangulation);</div>
<div class="line">  std::ifstream input_file(<span class="stringliteral">&quot;circle-grid.inp&quot;</span>);</div>
</div><!-- fragment --><p>We would now like to read the file. However, the input file is only for a two-dimensional triangulation, while this function is a template for arbitrary dimension. Since this is only a demonstration program, we will not use different input files for the different dimensions, but rather kill the whole program if we are not in 2D:</p>
<div class="fragment"><div class="line"><a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a> (dim==2, <a class="code" href="group__Exceptions.html#gae372f2b2b6a64585eb80ca01d0b0e236">ExcInternalError</a>());</div>
</div><!-- fragment --><p>ExcInternalError is a globally defined exception, which may be thrown whenever something is terribly wrong. Usually, one would like to use more specific exceptions, and particular in this case one would of course try to do something else if <code>dim</code> is not equal to two, e.g. create a grid using library functions. Aborting a program is usually not a good idea and assertions should really only be used for exceptional cases which should not occur, but might due to stupidity of the programmer, user, or someone else. The situation above is not a very clever use of Assert, but again: this is a tutorial and it might be worth to show what not to do, after all.</p>
<p>So if we got past the assertion, we know that dim==2, and we can now actually read the grid. It is in UCD (unstructured cell data) format (but the ending of the <code>UCD</code>-file is <code>inp</code>), as supported as input format by the AVS Explorer (a visualization program), for example:</p>
<div class="fragment"><div class="line">grid_in.<a class="code" href="classGridIn.html#ae42db87a00fa294beb49c9fb0f346271">read_ucd</a> (input_file);</div>
</div><!-- fragment --><p>If you like to use another input format, you have to use an other <code>grid_in.read_xxx</code> function. (See the documentation of the <code><a class="el" href="classGridIn.html">GridIn</a></code> class to find out what input formats are presently supported.)</p>
<p>The grid in the file describes a circle. Therefore we have to use a boundary object which tells the triangulation where to put new points on the boundary when the grid is refined. This works in the same way as in the first example. Note that the <a class="el" href="classHyperBallBoundary.html">HyperBallBoundary</a> constructor takes two parameters, the center of the ball and the radius, but that their default (the origin and 1.0) are the ones which we would like to use here.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classHyperBallBoundary.html">HyperBallBoundary&lt;dim&gt;</a> boundary;</div>
<div class="line">triangulation.<a class="code" href="group__boundary.html#ga0509d862f0e07071dcff837bd58fd082">set_boundary</a> (0, boundary);</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle=0; cycle&lt;6; ++cycle)</div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (cycle != 0)</div>
<div class="line">      triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a> (1);</div>
</div><!-- fragment --><p>Now that we have a mesh for sure, we write some output and do all the things that we have already seen in the previous examples.</p>
<div class="fragment"><div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;   Number of active cells: &quot;</span></div>
<div class="line">                &lt;&lt; triangulation.<a class="code" href="classTriangulation.html#aa21f25016ce1b9d70d2003a128985870">n_active_cells</a>()</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;   Total number of cells: &quot;</span></div>
<div class="line">                &lt;&lt; triangulation.<a class="code" href="classTriangulation.html#a07ed51250524b5b9599671be911c89c4">n_cells</a>()</div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">      setup_system ();</div>
<div class="line">      assemble_system ();</div>
<div class="line">      solve ();</div>
<div class="line">      output_results (cycle);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a> </p>
<h3>The <code>main</code> function</h3>
<p>The main function looks mostly like the one in the previous example, so we won't comment on it further:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__ParameterGui.html#ga0ddf1224851353fc92bfbff6f499fa97">main</a> ()</div>
<div class="line">{</div>
<div class="line">  deallog.<a class="code" href="classLogStream.html#a8028e970ad8388596d625ed463894e98">depth_console</a> (0);</div>
<div class="line"></div>
<div class="line">  Step5&lt;2&gt; laplace_problem_2d;</div>
<div class="line">  laplace_problem_2d.run ();</div>
</div><!-- fragment --><p>Finally, we have promised to trigger an exception in the <code>Coefficient</code> class through the <code>Assert</code> macro we have introduced there. For this, we have to call its <code>value_list</code> function with two arrays of different size (the number in parentheses behind the declaration of the object). We have commented out these lines in order to allow the program to exit gracefully in normal situations (we use the program in day-to-day testing of changes to the library as well), so you will only get the exception by un-commenting the following lines. Take a look at the Results section of the program to see what happens when the code is actually run:</p>
<div class="fragment"><div class="line">  / *</div>
<div class="line">    Coefficient&lt;2&gt;    coefficient;</div>
<div class="line">    std::vector&lt;Point&lt;2&gt; &gt; points (2);</div>
<div class="line">    std::vector&lt;double&gt;    coefficient_values (1);</div>
<div class="line">    coefficient.value_list (points, coefficient_values);</div>
<div class="line">  * /</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a></p>
<h1>Results</h1>
<p>When the last block in <code><a class="el" href="group__ParameterGui.html#ga0ddf1224851353fc92bfbff6f499fa97">main()</a></code> is commented in, the output of the program looks as follows: </p>
<div class="fragment"><div class="line">Cycle 0:</div>
<div class="line">   Number of active cells: 20</div>
<div class="line">   Total number of cells: 20</div>
<div class="line">   Number of degrees of freedom: 25</div>
<div class="line">   13 CG iterations needed to obtain convergence.</div>
<div class="line">Cycle 1:</div>
<div class="line">   Number of active cells: 80</div>
<div class="line">   Total number of cells: 100</div>
<div class="line">   Number of degrees of freedom: 89</div>
<div class="line">   18 CG iterations needed to obtain convergence.</div>
<div class="line">Cycle 2:</div>
<div class="line">   Number of active cells: 320</div>
<div class="line">   Total number of cells: 420</div>
<div class="line">   Number of degrees of freedom: 337</div>
<div class="line">   29 CG iterations needed to obtain convergence.</div>
<div class="line">Cycle 3:</div>
<div class="line">   Number of active cells: 1280</div>
<div class="line">   Total number of cells: 1700</div>
<div class="line">   Number of degrees of freedom: 1313</div>
<div class="line">   52 CG iterations needed to obtain convergence.</div>
<div class="line">Cycle 4:</div>
<div class="line">   Number of active cells: 5120</div>
<div class="line">   Total number of cells: 6820</div>
<div class="line">   Number of degrees of freedom: 5185</div>
<div class="line">   95 CG iterations needed to obtain convergence.</div>
<div class="line">Cycle 5:</div>
<div class="line">   Number of active cells: 20480</div>
<div class="line">   Total number of cells: 27300</div>
<div class="line">   Number of degrees of freedom: 20609</div>
<div class="line">   182 CG iterations needed to obtain convergence.</div>
<div class="line">--------------------------------------------------------</div>
<div class="line">An error occurred in line &lt;273&gt; of file &lt;step-5.cc&gt; in <span class="keyword">function</span></div>
<div class="line">    <span class="keywordtype">void</span> Coefficient&lt;dim&gt;::value_list(<span class="keyword">const</span> std::vector&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>, std::allocator&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &gt; &gt;&amp;, std::vector&lt;<span class="keywordtype">double</span>, std::allocator&lt;double&gt; &gt;&amp;, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)</div>
<div class="line"> <span class="keyword">const</span> [with <span class="keywordtype">int</span> dim = 2]</div>
<div class="line">The violated condition was:</div>
<div class="line">    values.size() == points.size()</div>
<div class="line">The name and call sequence of the exception was:</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga325fd73751a9373f1b901962daeb2ea7">ExcDimensionMismatch</a> (values.size(), points.size())</div>
<div class="line">Additional Information:</div>
<div class="line">Dimension 1 not equal to 2</div>
<div class="line"></div>
<div class="line">Stacktrace:</div>
<div class="line">-----------</div>
<div class="line">#0  ./step-5: Coefficient&lt;2&gt;::value_list(std::vector&lt;<a class="code" href="classPoint.html">Point&lt;2&gt;</a>, std::allocator&lt;<a class="code" href="classPoint.html">Point&lt;2&gt;</a> &gt; &gt; <span class="keyword">const</span>&amp;, std::vector&lt;<span class="keywordtype">double</span>, std::allocator&lt;double&gt; &gt;&amp;, <span class="keywordtype">unsigned</span>) const</div>
<div class="line"><span class="preprocessor">#1  ./step-5: main</span></div>
<div class="line">--------------------------------------------------------</div>
<div class="line">make: *** [run] Aborted</div>
</div><!-- fragment --><p>Let's first focus on the things before the error: In each cycle, the number of cells quadruples and the number of CG iterations roughly doubles. Also, in each cycle, the program writes one output graphic file in EPS format. They are depicted in the following:</p>
<table  width="100%">
<tr>
<td><div class="image">
<img src="images/step-5.solution-0.png" />
</div>
  </td><td><div class="image">
<img src="images/step-5.solution-1.png" />
</div>
  <p class="endtd"></p>
</td></tr>
<tr>
<td><div class="image">
<img src="images/step-5.solution-2.png" />
</div>
  </td><td><div class="image">
<img src="images/step-5.solution-3.png" />
</div>
  <p class="endtd"></p>
</td></tr>
<tr>
<td><div class="image">
<img src="images/step-5.solution-4.png" />
</div>
  </td><td><div class="image">
<img src="images/step-5.solution-5.png" />
</div>
   </td></tr>
</table>
<p>Due to the variable coefficient (the curvature there is reduced by the same factor by which the coefficient is increased), the top region of the solution is flattened. The gradient of the solution is discontinuous there, although this is not very clearly visible in the pictures above. We will look at this in more detail in the next example.</p>
<p>As for the error &mdash; let's look at it again: </p>
<div class="fragment"><div class="line">--------------------------------------------------------</div>
<div class="line">An error occurred in line &lt;273&gt; of file &lt;step-5.cc&gt; in <span class="keyword">function</span></div>
<div class="line">    <span class="keywordtype">void</span> Coefficient&lt;dim&gt;::value_list(<span class="keyword">const</span> std::vector&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>, std::allocator&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &gt; &gt;&amp;, std::vector&lt;<span class="keywordtype">double</span>, std::allocator&lt;double&gt; &gt;&amp;, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)</div>
<div class="line"> <span class="keyword">const</span> [with <span class="keywordtype">int</span> dim = 2]</div>
<div class="line">The violated condition was:</div>
<div class="line">    values.size() == points.size()</div>
<div class="line">The name and call sequence of the exception was:</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga325fd73751a9373f1b901962daeb2ea7">ExcDimensionMismatch</a> (values.size(), points.size())</div>
<div class="line">Additional Information:</div>
<div class="line">Dimension 1 not equal to 2</div>
<div class="line"></div>
<div class="line">Stacktrace:</div>
<div class="line">-----------</div>
<div class="line">#0  ./step-5: Coefficient&lt;2&gt;::value_list(std::vector&lt;<a class="code" href="classPoint.html">Point&lt;2&gt;</a>, std::allocator&lt;<a class="code" href="classPoint.html">Point&lt;2&gt;</a> &gt; &gt; <span class="keyword">const</span>&amp;, std::vector&lt;<span class="keywordtype">double</span>, std::allocator&lt;double&gt; &gt;&amp;, <span class="keywordtype">unsigned</span>) const</div>
<div class="line"><span class="preprocessor">#1  ./step-5: main</span></div>
<div class="line">--------------------------------------------------------</div>
<div class="line">make: *** [run] Aborted</div>
</div><!-- fragment --><p>What we see is that the error was triggered in line 273 of the <a class="el" href="step_5.html">step-5</a>.cc file (as we modify tutorial programs over time, these line numbers change, so you should check what line number you actually get in your output). That's already good information if you want to look up in the code what exactly happened. But the text tells you even more. First, it prints the function this happens in, and then the plain text version of the condition that was violated. This will almost always be enough already to let you know what exactly went wrong.</p>
<p>But that's not all yet. You get to see the name of the exception (<code>ExcDimensionMismatch</code>) and this exception even prints the values of the two array sizes. If you go back to the code in <code><a class="el" href="group__ParameterGui.html#ga0ddf1224851353fc92bfbff6f499fa97">main()</a></code>, you will remember that we gave the two variables sizes 1 and 2, which of course are the ones that you find in the output again.</p>
<p>So now we know pretty exactly where the error happened and what went wrong. What we don't know yet is how exactly we got there. The stacktrace at the bottom actually tells us what happened: the problem happened in <code>Coefficient::value_list</code> (stackframe 0) and that it was called from <code><a class="el" href="group__ParameterGui.html#ga0ddf1224851353fc92bfbff6f499fa97">main()</a></code> (stackframe 1). In realistic programs, there would be many more functions in between these two. For example, we might have made the mistake in the <code>assemble_system</code> function, in which case stack frame 1 would be <code>Step5::assemble_system</code>, stack frame 2 would be <code>Step5::run</code>, and stack frame 3 would be <code><a class="el" href="group__ParameterGui.html#ga0ddf1224851353fc92bfbff6f499fa97">main()</a></code> &mdash; you get the idea.</p>
<p><a class="anchor" id="PlainProg"></a> </p>
<h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * @f$Id: @ref step_5 &quot;step-5&quot;.cc 30147 2013-07-24 09:28:41Z maier @f$</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 1999 - 2013 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE at</span></div>
<div class="line"><span class="comment"> * the top level of the deal.II distribution.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Author: Wolfgang Bangerth, University of Heidelberg, 1999</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/base/quadrature_lib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/base/function.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/base/logstream.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/vector.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/full_matrix.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/sparse_matrix.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/compressed_sparsity_pattern.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/solver_cg.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/precondition.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_handler.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria_accessor.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria_iterator.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_accessor.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_tools.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/fe/fe_q.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/fe/fe_values.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/vector_tools.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/matrix_tools.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/data_out.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/grid_in.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria_boundary_lib.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">using namespace </span>dealii;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>Step5</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  Step5 ();</div>
<div class="line">  <span class="keywordtype">void</span> run ();</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> setup_system ();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_system ();</div>
<div class="line">  <span class="keywordtype">void</span> solve ();</div>
<div class="line">  <span class="keywordtype">void</span> output_results (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle) <span class="keyword">const</span>;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>   triangulation;</div>
<div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>            fe;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>      dof_handler;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern;</div>
<div class="line">  <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>       solution;</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>       system_rhs;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>Coefficient : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  Coefficient ()  : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;() {}</div>
<div class="line"></div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> value (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>   &amp;p,</div>
<div class="line">                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  component = 0) <span class="keyword">const</span>;</div>
<div class="line"></div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> value_list (<span class="keyword">const</span> std::vector&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &gt; &amp;points,</div>
<div class="line">                           std::vector&lt;double&gt;            &amp;values,</div>
<div class="line">                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>              component = 0) <span class="keyword">const</span>;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> Coefficient&lt;dim&gt;::value (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div>
<div class="line">                                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">if</span> (p.<a class="code" href="classPoint.html#ad46f55479010282e242b1d8e427285e8">square</a>() &lt; 0.5*0.5)</div>
<div class="line">    <span class="keywordflow">return</span> 20;</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Coefficient&lt;dim&gt;::value_list (<span class="keyword">const</span> std::vector&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &gt; &amp;points,</div>
<div class="line">                                   std::vector&lt;double&gt;            &amp;values,</div>
<div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>              component)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a> (values.size() == points.size(),</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga325fd73751a9373f1b901962daeb2ea7">ExcDimensionMismatch</a> (values.size(), points.size()));</div>
<div class="line"></div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a> (component == 0,</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga3f3f87a5613ac8b4e64ecd458dea8e9b">ExcIndexRange</a> (component, 0, 1));</div>
<div class="line"></div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_points = points.size();</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;n_points; ++i)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (points[i].square() &lt; 0.5*0.5)</div>
<div class="line">        values[i] = 20;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        values[i] = 1;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">Step5&lt;dim&gt;::Step5 () :</div>
<div class="line">  fe (1),</div>
<div class="line">  dof_handler (triangulation)</div>
<div class="line">{}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step5&lt;dim&gt;::setup_system ()</div>
<div class="line">{</div>
<div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#afcfcc3b473f444f50d206ae62dfe3694">distribute_dofs</a> (fe);</div>
<div class="line"></div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span></div>
<div class="line">            &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#a54e7270f2ba6206604f794114b39a2aa">n_dofs</a>()</div>
<div class="line">            &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classCompressedSparsityPattern.html">CompressedSparsityPattern</a> c_sparsity(dof_handler.<a class="code" href="classDoFHandler.html#a54e7270f2ba6206604f794114b39a2aa">n_dofs</a>());</div>
<div class="line">  <a class="code" href="group__constraints.html#gab627b1d4845c9526521dbd1be83469dc">DoFTools::make_sparsity_pattern</a> (dof_handler, c_sparsity);</div>
<div class="line">  sparsity_pattern.<a class="code" href="classSparsityPattern.html#aafd93c00be64a9ab832c68aefaecace6">copy_from</a>(c_sparsity);</div>
<div class="line"></div>
<div class="line">  system_matrix.reinit (sparsity_pattern);</div>
<div class="line"></div>
<div class="line">  solution.<a class="code" href="classVector.html#ac3adfcf8cf35943558fc27ef989b7263">reinit</a> (dof_handler.<a class="code" href="classDoFHandler.html#a54e7270f2ba6206604f794114b39a2aa">n_dofs</a>());</div>
<div class="line">  system_rhs.reinit (dof_handler.<a class="code" href="classDoFHandler.html#a54e7270f2ba6206604f794114b39a2aa">n_dofs</a>());</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step5&lt;dim&gt;::assemble_system ()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(2);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values (fe, quadrature_formula,</div>
<div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>    |  <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>  |  <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"></div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#a4d64837b1d374e9c46f07af8f094b29b">size</a>();</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>   cell_matrix (dofs_per_cell, dofs_per_cell);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>       cell_rhs (dofs_per_cell);</div>
<div class="line"></div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; local_dof_indices (dofs_per_cell);</div>
<div class="line"></div>
<div class="line">  <span class="keyword">const</span> Coefficient&lt;dim&gt; coefficient;</div>
<div class="line">  std::vector&lt;double&gt;    coefficient_values (n_q_points);</div>
<div class="line"></div>
<div class="line">  <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a></div>
<div class="line">  cell = dof_handler.<a class="code" href="classDoFHandler.html#a6f2aa9c61385cbb749ed3d2e7bfe3de1">begin_active</a>(),</div>
<div class="line">  endc = dof_handler.<a class="code" href="classDoFHandler.html#abf64c3734383b6fb1bed4888935f2edf">end</a>();</div>
<div class="line">  <span class="keywordflow">for</span> (; cell!=endc; ++cell)</div>
<div class="line">    {</div>
<div class="line">      cell_matrix = 0;</div>
<div class="line">      cell_rhs = 0;</div>
<div class="line"></div>
<div class="line">      fe_values.<a class="code" href="classFEValues.html#afde502903642c57ade24dfcebf5c1650">reinit</a> (cell);</div>
<div class="line"></div>
<div class="line">      coefficient.value_list (fe_values.<a class="code" href="classFEValuesBase.html#a5f8732ebe2d3c6746f6de26a79cb1e45">get_quadrature_points</a>(),</div>
<div class="line">                              coefficient_values);</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point=0; q_point&lt;n_q_points; ++q_point)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;dofs_per_cell; ++i)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j=0; j&lt;dofs_per_cell; ++j)</div>
<div class="line">              cell_matrix(i,j) += (coefficient_values[q_point] *</div>
<div class="line">                                   fe_values.<a class="code" href="classFEValuesBase.html#ac4cee7628c2903a89c5c399fddeb00a5">shape_grad</a>(i,q_point) *</div>
<div class="line">                                   fe_values.<a class="code" href="classFEValuesBase.html#ac4cee7628c2903a89c5c399fddeb00a5">shape_grad</a>(j,q_point) *</div>
<div class="line">                                   fe_values.<a class="code" href="classFEValuesBase.html#ad097580a2f71878695096cc73b271b9d">JxW</a>(q_point));</div>
<div class="line"></div>
<div class="line">            cell_rhs(i) += (fe_values.<a class="code" href="classFEValuesBase.html#abe4de48ff59778bb82a0ec13037804aa">shape_value</a>(i,q_point) *</div>
<div class="line">                            1.0 *</div>
<div class="line">                            fe_values.<a class="code" href="classFEValuesBase.html#ad097580a2f71878695096cc73b271b9d">JxW</a>(q_point));</div>
<div class="line">          }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">      cell-&gt;get_dof_indices (local_dof_indices);</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;dofs_per_cell; ++i)</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j=0; j&lt;dofs_per_cell; ++j)</div>
<div class="line">            system_matrix.add (local_dof_indices[i],</div>
<div class="line">                               local_dof_indices[j],</div>
<div class="line">                               cell_matrix(i,j));</div>
<div class="line"></div>
<div class="line">          system_rhs(local_dof_indices[i]) += cell_rhs(i);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">  std::map&lt;types::global_dof_index,double&gt; boundary_values;</div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#a199f38e07822b47e5b5957c21ce35d1b">VectorTools::interpolate_boundary_values</a> (dof_handler,</div>
<div class="line">                                            0,</div>
<div class="line">                                            <a class="code" href="classZeroFunction.html">ZeroFunction&lt;dim&gt;</a>(),</div>
<div class="line">                                            boundary_values);</div>
<div class="line">  <a class="code" href="namespaceMatrixTools.html#a41a069894610445f84840d712d4f891e">MatrixTools::apply_boundary_values</a> (boundary_values,</div>
<div class="line">                                      system_matrix,</div>
<div class="line">                                      solution,</div>
<div class="line">                                      system_rhs);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step5&lt;dim&gt;::solve ()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a>           solver_control (1000, 1e-12);</div>
<div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;&gt;</a>              solver (solver_control);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;&gt;</a> preconditioner;</div>
<div class="line">  preconditioner.<a class="code" href="classPreconditionSSOR.html#aa564d2dbcdcf09c6ceed549f319b5465">initialize</a>(system_matrix, 1.2);</div>
<div class="line"></div>
<div class="line">  solver.solve (system_matrix, solution, system_rhs,</div>
<div class="line">                preconditioner);</div>
<div class="line"></div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot; CG iterations needed to obtain convergence.&quot;</span></div>
<div class="line">            &lt;&lt; std::endl;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step5&lt;dim&gt;::output_results (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line"></div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a5e63bad650805ce93cd74c6dc3b29b11">attach_dof_handler</a> (dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a59a6b70a4b909e0229a20487dd68cc43">add_data_vector</a> (solution, <span class="stringliteral">&quot;solution&quot;</span>);</div>
<div class="line"></div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#ab3d44201acb97fba286a897452236b51">build_patches</a> ();</div>
<div class="line"></div>
<div class="line">  <a class="code" href="structDataOutBase_1_1EpsFlags.html">DataOutBase::EpsFlags</a> eps_flags;</div>
<div class="line">  eps_flags.<a class="code" href="structDataOutBase_1_1EpsFlags.html#aae56c32425575726b67b106edef3787b">z_scaling</a> = 4;</div>
<div class="line">  eps_flags.<a class="code" href="structDataOutBase_1_1EpsFlags.html#afb565808367b204a1abbc5ecdf68278b">azimut_angle</a> = 40;</div>
<div class="line">  eps_flags.<a class="code" href="structDataOutBase_1_1EpsFlags.html#a3afae76795cf33c76a3f65af902abf41">turn_angle</a>   = 10;</div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#ab62747d458c1415d4bdb5e5b0ea2a68f">set_flags</a> (eps_flags);</div>
<div class="line"></div>
<div class="line">  std::ostringstream filename;</div>
<div class="line"></div>
<div class="line">  filename &lt;&lt; <span class="stringliteral">&quot;solution-&quot;</span></div>
<div class="line">           &lt;&lt; cycle</div>
<div class="line">           &lt;&lt; <span class="stringliteral">&quot;.eps&quot;</span>;</div>
<div class="line"></div>
<div class="line">  std::ofstream output (filename.str().c_str());</div>
<div class="line"></div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#a16609dff8ed26b761521930933679b7e">write_eps</a> (output);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step5&lt;dim&gt;::run ()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classGridIn.html">GridIn&lt;dim&gt;</a> grid_in;</div>
<div class="line">  grid_in.<a class="code" href="classGridIn.html#a82ac1c03b0efe87204ad45d2f1d87f7e">attach_triangulation</a> (triangulation);</div>
<div class="line">  std::ifstream input_file(<span class="stringliteral">&quot;circle-grid.inp&quot;</span>);</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a> (dim==2, <a class="code" href="group__Exceptions.html#gae372f2b2b6a64585eb80ca01d0b0e236">ExcInternalError</a>());</div>
<div class="line"></div>
<div class="line">  grid_in.<a class="code" href="classGridIn.html#ae42db87a00fa294beb49c9fb0f346271">read_ucd</a> (input_file);</div>
<div class="line"></div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classHyperBallBoundary.html">HyperBallBoundary&lt;dim&gt;</a> boundary;</div>
<div class="line">  triangulation.<a class="code" href="group__boundary.html#ga0509d862f0e07071dcff837bd58fd082">set_boundary</a> (0, boundary);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle=0; cycle&lt;6; ++cycle)</div>
<div class="line">    {</div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">if</span> (cycle != 0)</div>
<div class="line">        triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a> (1);</div>
<div class="line"></div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;   Number of active cells: &quot;</span></div>
<div class="line">                &lt;&lt; triangulation.<a class="code" href="classTriangulation.html#aa21f25016ce1b9d70d2003a128985870">n_active_cells</a>()</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;   Total number of cells: &quot;</span></div>
<div class="line">                &lt;&lt; triangulation.<a class="code" href="classTriangulation.html#a07ed51250524b5b9599671be911c89c4">n_cells</a>()</div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">      setup_system ();</div>
<div class="line">      assemble_system ();</div>
<div class="line">      solve ();</div>
<div class="line">      output_results (cycle);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="group__ParameterGui.html#ga0ddf1224851353fc92bfbff6f499fa97">main</a> ()</div>
<div class="line">{</div>
<div class="line">  deallog.<a class="code" href="classLogStream.html#a8028e970ad8388596d625ed463894e98">depth_console</a> (0);</div>
<div class="line"></div>
<div class="line">  Step5&lt;2&gt; laplace_problem_2d;</div>
<div class="line">  laplace_problem_2d.run ();</div>
<div class="line"></div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">    Coefficient&lt;2&gt;    coefficient;</span></div>
<div class="line"><span class="comment">    std::vector&lt;Point&lt;2&gt; &gt; points (2);</span></div>
<div class="line"><span class="comment">    std::vector&lt;double&gt;    coefficient_values (1);</span></div>
<div class="line"><span class="comment">    coefficient.value_list (points, coefficient_values);</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.6-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Jan 27 2014 15:26:18 for The deal.II Library by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
