<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>The deal.II Library: The step-6 tutorial program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="http://www.dealii.org/deal.ico"></link>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2014 by the deal.II authors"></meta>
<meta name="deal.II-version" content="8.1.0"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 8.1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">The step-6 tutorial program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#TheConstraintMatrix">The ConstraintMatrix</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a>
        <li><a href="#ThecodeStep6codeclasstemplate">The <code>Step6</code> class template</a>
        <li><a href="#Nonconstantcoefficients">Nonconstant coefficients</a>
        <li><a href="#ThecodeStep6codeclassimplementation">The <code>Step6</code> class implementation</a>
      <ul>
        <li><a href="#Step6Step6">Step6::Step6</a>
        <li><a href="#Step6Step6">Step6::~Step6</a>
        <li><a href="#Step6setup_system">Step6::setup_system</a>
        <li><a href="#Step6assemble_system">Step6::assemble_system</a>
        <li><a href="#Step6solve">Step6::solve</a>
        <li><a href="#Step6refine_grid">Step6::refine_grid</a>
        <li><a href="#Step6output_results">Step6::output_results</a>
        <li><a href="#Step6run">Step6::run</a>
      </ul>
        <li><a href="#Thecodemaincodefunction">The <code>main</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p>
<h1>Introduction</h1>
<p>The main emphasis in this example is the handling of locally refined grids. The approach to adaptivity chosen in deal.II is to use grids in which neighboring cells may be refined a different number of times. This then results in nodes on the interfaces of cells which belong to one side, but are unbalanced on the other. The common term for these is &ldquo;hanging nodes&rdquo;.</p>
<p>To guarantee that the global solution is continuous at these nodes as well, we have to state some additional constraints on the values of the solution at these nodes. In the program below, we will show how we can get these constraints from the library, and how to use them in the solution of the linear system of equations. Before going over the details of the program below, you may want to take a look at the <a class="el" href="group__constraints.html">Constraints on degrees of freedom</a> documentation module that explains how these constraints can be computed and what classes in deal.II work on them.</p>
<p>The locally refined grids are produced using an error estimator class which estimates the energy error with respect to the Laplace operator. This error estimator, although developed for Laplace's equation has proven to be a suitable tool to generate locally refined meshes for a wide range of equations, not restricted to elliptic problems. Although it will create non-optimal meshes for other equations, it is often a good way to quickly produce meshes that are well adapted to the features of solutions, such as regions of great variation or discontinuities. Since it was developed by Kelly and co-workers, we often refer to it as the &ldquo;Kelly refinement indicator&rdquo; in the library, documentation, and mailing list. The class that implements it is called <a class="el" href="classKellyErrorEstimator.html">KellyErrorEstimator</a>. Although the error estimator (and its implementation in the deal.II library) is capable of handling variable coefficients in the equation, we will not use this feature since we are only interested in a quick and simple way to generate locally refined grids.</p>
<p>Since the concepts used for locally refined grids are so important, we do not show much additional new stuff in this example. The most important exception is that we show how to use biquadratic elements instead of the bilinear ones which we have used in all previous examples. In fact, The use of higher order elements is accomplished by only replacing three lines of the program, namely the declaration of the <code>fe</code> variable, and the use of an appropriate quadrature formula in two places. The rest of the program is unchanged.</p>
<p>The only other new thing is a method to catch exceptions in the <code>main</code> function in order to output some information in case the program crashes for some reason.</p>
<p><a class="anchor" id="TheConstraintMatrix"></a></p>
<h3>The <a class="el" href="classConstraintMatrix.html">ConstraintMatrix</a></h3>
<p>As explained above, we are going to use an object called <a class="el" href="classConstraintMatrix.html">ConstraintMatrix</a> that will store the constraints at the hanging nodes to insure the solution is continuous at these nodes. We could first assemble the system as normal and then condense out the degrees of freedom that need to be constrained. This is also explained <a class="el" href="group__constraints.html">Constraints on degrees of freedom</a> documentation module. Instead we will go the more efficient route and eliminate the constrained entries while we are copying from the local to the global system. Because boundary conditions can be treated in the same way, we will incorporate the them as constraints in the same <a class="el" href="classConstraintMatrix.html">ConstraintMatrix</a> object. This way, we don't need to apply the boundary conditions after assembly (like we did in the earlier steps). <a class="anchor" id="CommProg"></a> </p>
<h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p>
<h3>Include files</h3>
<p>The first few files have already been covered in previous examples and will thus not be further commented on.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;deal.II/base/quadrature_lib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/base/function.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/base/logstream.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/vector.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/full_matrix.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/sparse_matrix.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/compressed_sparsity_pattern.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/solver_cg.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/precondition.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_handler.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/grid_generator.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria_accessor.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria_iterator.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria_boundary_lib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_accessor.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_tools.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/fe/fe_values.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/vector_tools.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/matrix_tools.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/data_out.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
</div><!-- fragment --><p>From the following include file we will import the declaration of H1-conforming finite element shape functions. This family of finite elements is called <code><a class="el" href="classFE__Q.html">FE_Q</a></code>, and was used in all examples before already to define the usual bi- or tri-linear elements, but we will now use it for bi-quadratic elements:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;deal.II/fe/fe_q.h&gt;</span></div>
</div><!-- fragment --><p>We will not read the grid from a file as in the previous example, but generate it using a function of the library. However, we will want to write out the locally refined grids (just the grid, not the solution) in each step, so we need the following include file instead of <code><a class="el" href="grid__in_8h_source.html">grid_in.h</a></code>:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;deal.II/grid/grid_out.h&gt;</span></div>
</div><!-- fragment --><p>When using locally refined grids, we will get so-called <code>hanging nodes</code>. However, the standard finite element methods assumes that the discrete solution spaces be continuous, so we need to make sure that the degrees of freedom on hanging nodes conform to some constraints such that the global solution is continuous. We are also going to store the boundary conditions in this object. The following file contains a class which is used to handle these constraints:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;deal.II/lac/constraint_matrix.h&gt;</span></div>
</div><!-- fragment --><p>In order to refine our grids locally, we need a function from the library that decides which cells to flag for refinement or coarsening based on the error indicators we have computed. This function is defined here:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;deal.II/grid/grid_refinement.h&gt;</span></div>
</div><!-- fragment --><p>Finally, we need a simple way to actually compute the refinement indicators based on some error estimate. While in general, adaptivity is very problem-specific, the error indicator in the following file often yields quite nicely adapted grids for a wide class of problems.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/error_estimator.h&gt;</span></div>
</div><!-- fragment --><p>Finally, this is as in previous programs:</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span>dealii;</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeStep6codeclasstemplate"></a> </p>
<h3>The <code>Step6</code> class template</h3>
<p>The main class is again almost unchanged. Two additions, however, are made: we have added the <code>refine_grid</code> function, which is used to adaptively refine the grid (instead of the global refinement in the previous examples), and a variable which will hold the constraints. In addition, we have added a destructor to the class for reasons that will become clear when we discuss its implementation.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>Step6</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  Step6 ();</div>
<div class="line">  ~Step6 ();</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">void</span> run ();</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> setup_system ();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_system ();</div>
<div class="line">  <span class="keywordtype">void</span> solve ();</div>
<div class="line">  <span class="keywordtype">void</span> refine_grid ();</div>
<div class="line">  <span class="keywordtype">void</span> output_results (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle) <span class="keyword">const</span>;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>   triangulation;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>      dof_handler;</div>
<div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>            fe;</div>
</div><!-- fragment --><p>This is the new variable in the main class. We need an object which holds a list of constraints to hold the hanging nodes and the boundary conditions.</p>
<div class="fragment"><div class="line">  <a class="code" href="classConstraintMatrix.html">ConstraintMatrix</a>     constraints;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern;</div>
<div class="line">  <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>       solution;</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>       system_rhs;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="Nonconstantcoefficients"></a> </p>
<h3>Nonconstant coefficients</h3>
<p>The implementation of nonconstant coefficients is copied verbatim from <a class="el" href="step_5.html">step-5</a>:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>Coefficient : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  Coefficient () : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;() {}</div>
<div class="line"></div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#a9783cc12b6b205d4019379b0cc6f3956">value</a> (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>   &amp;p,</div>
<div class="line">                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  component = 0) <span class="keyword">const</span>;</div>
<div class="line"></div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classFunction.html#af6f1aceeeb499ff07d828df250f4f3b2">value_list</a> (<span class="keyword">const</span> std::vector&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &gt; &amp;points,</div>
<div class="line">                           std::vector&lt;double&gt;            &amp;values,</div>
<div class="line">                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>              component = 0) <span class="keyword">const</span>;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> Coefficient&lt;dim&gt;::value (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div>
<div class="line">                                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">if</span> (p.<a class="code" href="classPoint.html#ad46f55479010282e242b1d8e427285e8">square</a>() &lt; 0.5*0.5)</div>
<div class="line">    <span class="keywordflow">return</span> 20;</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Coefficient&lt;dim&gt;::value_list (<span class="keyword">const</span> std::vector&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &gt; &amp;points,</div>
<div class="line">                                   std::vector&lt;double&gt;            &amp;values,</div>
<div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>              component)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_points = points.size();</div>
<div class="line"></div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a> (values.size() == n_points,</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga325fd73751a9373f1b901962daeb2ea7">ExcDimensionMismatch</a> (values.size(), n_points));</div>
<div class="line"></div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a> (component == 0,</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga3f3f87a5613ac8b4e64ecd458dea8e9b">ExcIndexRange</a> (component, 0, 1));</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;n_points; ++i)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (points[i].square() &lt; 0.5*0.5)</div>
<div class="line">        values[i] = 20;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        values[i] = 1;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeStep6codeclassimplementation"></a> </p>
<h3>The <code>Step6</code> class implementation</h3>
<p><a class="anchor" id="Step6Step6"></a> </p>
<h4>Step6::Step6</h4>
<p>The constructor of this class is mostly the same as before, but this time we want to use the quadratic element. To do so, we only have to replace the constructor argument (which was <code>1</code> in all previous examples) by the desired polynomial degree (here <code>2</code>):</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">Step6&lt;dim&gt;::Step6 ()</div>
<div class="line">  :</div>
<div class="line">  dof_handler (triangulation),</div>
<div class="line">  fe (2)</div>
<div class="line">{}</div>
</div><!-- fragment --><p><a class="anchor" id="Step6Step6"></a> </p>
<h4>Step6::~Step6</h4>
<p>Here comes the added destructor of the class. The reason why we want to add it is a subtle change in the order of data elements in the class as compared to all previous examples: the <code>dof_handler</code> object was defined before and not after the <code>fe</code> object. Of course we could have left this order unchanged, but we would like to show what happens if the order is reversed since this produces a rather nasty side-effect and results in an error which is difficult to track down if one does not know what happens.</p>
<p>Basically what happens is the following: when we distribute the degrees of freedom using the function call <code>dof_handler.distribute_dofs()</code>, the <code>dof_handler</code> also stores a pointer to the finite element in use. Since this pointer is used every now and then until either the degrees of freedom are re-distributed using another finite element object or until the <code>dof_handler</code> object is destroyed, it would be unwise if we would allow the finite element object to be deleted before the <code>dof_handler</code> object. To disallow this, the DoF handler increases a counter inside the finite element object which counts how many objects use that finite element (this is what the <code><a class="el" href="classSubscriptor.html">Subscriptor</a></code>/<code><a class="el" href="classSmartPointer.html">SmartPointer</a></code> class pair is used for, in case you want something like this for your own programs; see <a class="el" href="step_7.html">step-7</a> for a more complete discussion of this topic). The finite element object will refuse its destruction if that counter is larger than zero, since then some other objects might rely on the persistence of the finite element object. An exception will then be thrown and the program will usually abort upon the attempt to destroy the finite element.</p>
<p>To be fair, such exceptions about still used objects are not particularly popular among programmers using deal.II, since they only tell us that something is wrong, namely that some other object is still using the object that is presently being destructed, but most of the time not who this user is. It is therefore often rather time-consuming to find out where the problem exactly is, although it is then usually straightforward to remedy the situation. However, we believe that the effort to find invalid references to objects that do no longer exist is less if the problem is detected once the reference becomes invalid, rather than when non-existent objects are actually accessed again, since then usually only invalid data is accessed, but no error is immediately raised.</p>
<p>Coming back to the present situation, if we did not write this destructor, the compiler will generate code that triggers exactly the behavior sketched above. The reason is that member variables of the <code>Step6</code> class are destructed bottom-up (i.e. in reverse order of their declaration in the class), as always in C++. Thus, the finite element object will be destructed before the DoF handler object, since its declaration is below the one of the DoF handler. This triggers the situation above, and an exception will be raised when the <code>fe</code> object is destructed. What needs to be done is to tell the <code>dof_handler</code> object to release its lock to the finite element. Of course, the <code>dof_handler</code> will only release its lock if it really does not need the finite element any more, i.e. when all finite element related data is deleted from it. For this purpose, the <code><a class="el" href="classDoFHandler.html">DoFHandler</a></code> class has a function <code>clear</code> which deletes all degrees of freedom, and releases its lock to the finite element. After this, you can safely destruct the finite element object since its internal counter is then zero.</p>
<p>For completeness, we add the output of the exception that would have been triggered without this destructor, to the end of the results section of this example.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">Step6&lt;dim&gt;::~Step6 ()</div>
<div class="line">{</div>
<div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a78fda065d6f58e554a3335ea9b5b482e">clear</a> ();</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Step6setup_system"></a> </p>
<h4>Step6::setup_system</h4>
<p>The next function is setting up all the variables that describe the linear finite element problem, such as the DoF handler, the matrices, and vectors. The difference to what we did in <a class="el" href="step_5.html">step-5</a> is only that we now also have to take care of handing node constraints. These constraints are handled almost transparently by the library, i.e. you only need to know that they exist and how to get them, but you do not have to know how they are formed or what exactly is done with them.</p>
<p>At the beginning of the function, you find all the things that are the same as in <a class="el" href="step_5.html">step-5</a>: setting up the degrees of freedom (this time we have quadratic elements, but there is no difference from a user code perspective to the linear &ndash; or cubic, for that matter &ndash; case), generating the sparsity pattern, and initializing the solution and right hand side vectors. Note that the sparsity pattern will have significantly more entries per row now, since there are now 9 degrees of freedom per cell, not only four, that can couple with each other. The <code>dof_Handler.max_couplings_between_dofs()</code> call will take care of this, however:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step6&lt;dim&gt;::setup_system ()</div>
<div class="line">{</div>
<div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#afcfcc3b473f444f50d206ae62dfe3694">distribute_dofs</a> (fe);</div>
<div class="line"></div>
<div class="line">  solution.<a class="code" href="classVector.html#ac3adfcf8cf35943558fc27ef989b7263">reinit</a> (dof_handler.<a class="code" href="classDoFHandler.html#a54e7270f2ba6206604f794114b39a2aa">n_dofs</a>());</div>
<div class="line">  system_rhs.reinit (dof_handler.<a class="code" href="classDoFHandler.html#a54e7270f2ba6206604f794114b39a2aa">n_dofs</a>());</div>
</div><!-- fragment --><p>After setting up all the degrees of freedoms, here are now the differences compared to <a class="el" href="step_5.html">step-5</a>, all of which are related to constraints associated with the hanging nodes. In the class declaration, we have already allocated space for an object <code>constraints</code> that will hold a list of these constraints (they form a matrix, which is reflected in the name of the class, but that is immaterial for the moment). Now we have to fill this object. This is done using the following function calls (the first clears the contents of the object that may still be left over from computations on the previous mesh before the last adaptive refinement):</p>
<div class="fragment"><div class="line">constraints.<a class="code" href="classConstraintMatrix.html#a24120d0331183f9a63cbe41493a19f6b">clear</a> ();</div>
<div class="line"><a class="code" href="group__constraints.html#gabe9d21d4bb33ce556a6e6e80c2bf4b41">DoFTools::make_hanging_node_constraints</a> (dof_handler,</div>
<div class="line">                                         constraints);</div>
</div><!-- fragment --><p>Now we are ready to interpolate the <a class="el" href="classZeroFunction.html">ZeroFunction</a> to our boundary with indicator 0 (the whole boundary) and store the resulting constraints in our <code>constraints</code> object. Note that we do not to apply the boundary conditions after assembly, like we did in earlier steps. As almost all the stuff, the interpolation of boundary values works also for higher order elements without the need to change your code for that. We note that for proper results, it is important that the elimination of boundary nodes from the system of equations happens <em>after</em> the elimination of hanging nodes. For that reason we are filling the boundary values into the ContraintMatrix after the hanging node constraints.</p>
<div class="fragment"><div class="line"><a class="code" href="namespaceVectorTools.html#a199f38e07822b47e5b5957c21ce35d1b">VectorTools::interpolate_boundary_values</a> (dof_handler,</div>
<div class="line">                                          0,</div>
<div class="line">                                          <a class="code" href="classZeroFunction.html">ZeroFunction&lt;dim&gt;</a>(),</div>
<div class="line">                                          constraints);</div>
</div><!-- fragment --><p>The next step is <code>closing</code> this object. After all constraints have been added, they need to be sorted and rearranged to perform some actions more efficiently. This postprocessing is done using the <code>close()</code> function, after which no further constraints may be added any more:</p>
<div class="fragment"><div class="line">constraints.<a class="code" href="classConstraintMatrix.html#a8056d07faa2a7ed3f158c1b42d56abc8">close</a> ();</div>
</div><!-- fragment --><p>Now we first build our compressed sparsity pattern like we did in the previous examples. Nevertheless, we do not copy it to the final sparsity pattern immediately. Note that we call a variant of make_sparsity_pattern that takes the <a class="el" href="classConstraintMatrix.html">ConstraintMatrix</a> as the third argument. We are letting the routine know that we will never write into the locations given by <code>constraints</code> by setting the argument <code>keep_constrained_dofs</code> to false (in other words, that we will never write into entries of the matrix that correspond to constrained degrees of freedom). If we were to condense the constraints after assembling, we would have to pass <code>true</code> instead because then we would first write into these locations only to later set them to zero again during condensation.</p>
<div class="fragment"><div class="line"><a class="code" href="classCompressedSparsityPattern.html">CompressedSparsityPattern</a> c_sparsity(dof_handler.<a class="code" href="classDoFHandler.html#a54e7270f2ba6206604f794114b39a2aa">n_dofs</a>());</div>
<div class="line"><a class="code" href="group__constraints.html#gab627b1d4845c9526521dbd1be83469dc">DoFTools::make_sparsity_pattern</a>(dof_handler,</div>
<div class="line">                                c_sparsity,</div>
<div class="line">                                constraints,</div>
<div class="line">                                / *keep_constrained_dofs = * / <span class="keyword">false</span>);</div>
</div><!-- fragment --><p>Now all non-zero entries of the matrix are known (i.e. those from regularly assembling the matrix and those that were introduced by eliminating constraints). We can thus copy our intermediate object to the sparsity pattern:</p>
<div class="fragment"><div class="line">sparsity_pattern.<a class="code" href="classSparsityPattern.html#aafd93c00be64a9ab832c68aefaecace6">copy_from</a>(c_sparsity);</div>
</div><!-- fragment --><p>Finally, the so-constructed sparsity pattern serves as the basis on top of which we will create the sparse matrix:</p>
<div class="fragment"><div class="line">  system_matrix.reinit (sparsity_pattern);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Step6assemble_system"></a> </p>
<h4>Step6::assemble_system</h4>
<p>Next, we have to assemble the matrix again. There are two code changes compared to <a class="el" href="step_5.html">step-5</a>:</p>
<p>First, we have to use a higher-order quadrature formula to account for the higher polynomial degree in the finite element shape functions. This is easy to change: the constructor of the <code><a class="el" href="classQGauss.html">QGauss</a></code> class takes the number of quadrature points in each space direction. Previously, we had two points for bilinear elements. Now we should use three points for biquadratic elements.</p>
<p>Second, to copy the local matrix and vector on each cell into the global system, we are no longer using a hand-written loop. Instead, we use <code><a class="el" href="classConstraintMatrix.html#aa9f3612a8fc51eafa34252bb436e8ae4">ConstraintMatrix::distribute_local_to_global</a></code> that internally executes this loop and eliminates all the constraints at the same time.</p>
<p>The rest of the code that forms the local contributions remains unchanged. It is worth noting, however, that under the hood several things are different than before. First, the variables <code>dofs_per_cell</code> and <code>n_q_points</code> now are 9 each, where they were 4 before. Introducing such variables as abbreviations is a good strategy to make code work with different elements without having to change too much code. Secondly, the <code>fe_values</code> object of course needs to do other things as well, since the shape functions are now quadratic, rather than linear, in each coordinate variable. Again, however, this is something that is completely transparent to user code and nothing that you have to worry about.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step6&lt;dim&gt;::assemble_system ()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(3);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values (fe, quadrature_formula,</div>
<div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>    |  <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>  |  <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"></div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#a4d64837b1d374e9c46f07af8f094b29b">size</a>();</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>   cell_matrix (dofs_per_cell, dofs_per_cell);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>       cell_rhs (dofs_per_cell);</div>
<div class="line"></div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; local_dof_indices (dofs_per_cell);</div>
<div class="line"></div>
<div class="line">  <span class="keyword">const</span> Coefficient&lt;dim&gt; coefficient;</div>
<div class="line">  std::vector&lt;double&gt;    coefficient_values (n_q_points);</div>
<div class="line"></div>
<div class="line">  <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a></div>
<div class="line">  cell = dof_handler.<a class="code" href="classDoFHandler.html#a6f2aa9c61385cbb749ed3d2e7bfe3de1">begin_active</a>(),</div>
<div class="line">  endc = dof_handler.<a class="code" href="classDoFHandler.html#abf64c3734383b6fb1bed4888935f2edf">end</a>();</div>
<div class="line">  <span class="keywordflow">for</span> (; cell!=endc; ++cell)</div>
<div class="line">    {</div>
<div class="line">      cell_matrix = 0;</div>
<div class="line">      cell_rhs = 0;</div>
<div class="line"></div>
<div class="line">      fe_values.<a class="code" href="classFEValues.html#afde502903642c57ade24dfcebf5c1650">reinit</a> (cell);</div>
<div class="line"></div>
<div class="line">      coefficient.value_list (fe_values.<a class="code" href="classFEValuesBase.html#a5f8732ebe2d3c6746f6de26a79cb1e45">get_quadrature_points</a>(),</div>
<div class="line">                              coefficient_values);</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point=0; q_point&lt;n_q_points; ++q_point)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;dofs_per_cell; ++i)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j=0; j&lt;dofs_per_cell; ++j)</div>
<div class="line">              cell_matrix(i,j) += (coefficient_values[q_point] *</div>
<div class="line">                                   fe_values.<a class="code" href="classFEValuesBase.html#ac4cee7628c2903a89c5c399fddeb00a5">shape_grad</a>(i,q_point) *</div>
<div class="line">                                   fe_values.<a class="code" href="classFEValuesBase.html#ac4cee7628c2903a89c5c399fddeb00a5">shape_grad</a>(j,q_point) *</div>
<div class="line">                                   fe_values.<a class="code" href="classFEValuesBase.html#ad097580a2f71878695096cc73b271b9d">JxW</a>(q_point));</div>
<div class="line"></div>
<div class="line">            cell_rhs(i) += (fe_values.<a class="code" href="classFEValuesBase.html#abe4de48ff59778bb82a0ec13037804aa">shape_value</a>(i,q_point) *</div>
<div class="line">                            1.0 *</div>
<div class="line">                            fe_values.<a class="code" href="classFEValuesBase.html#ad097580a2f71878695096cc73b271b9d">JxW</a>(q_point));</div>
<div class="line">          }</div>
</div><!-- fragment --><p>Finally, transfer the contributions from <code>cell_matrix</code> and <code>cell_rhs</code> into the global objects.</p>
<div class="fragment"><div class="line">  cell-&gt;get_dof_indices (local_dof_indices);</div>
<div class="line">  constraints.<a class="code" href="classConstraintMatrix.html#aa9f3612a8fc51eafa34252bb436e8ae4">distribute_local_to_global</a>(cell_matrix,</div>
<div class="line">                                         cell_rhs,</div>
<div class="line">                                         local_dof_indices,</div>
<div class="line">                                         system_matrix, system_rhs);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Now we are done assembling the linear system. The constrained nodes are still in the linear system (there is a one on the diagonal of the matrix and all other entries for this line are set to zero) but the computed values are invalid. We compute the correct values for these nodes at the end of the <code>solve</code> function.</p>
<div class="fragment"><div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Step6solve"></a> </p>
<h4>Step6::solve</h4>
<p>We continue with gradual improvements. The function that solves the linear system again uses the SSOR preconditioner, and is again unchanged except that we have to incorporate hanging node constraints. As mentioned above, the degrees of freedom from the <a class="el" href="classConstraintMatrix.html">ConstraintMatrix</a> corresponding to hanging node constraints and boundary values have been removed from the linear system by giving the rows and columns of the matrix a special treatment. This way, the values for these degrees of freedom have wrong, but well-defined values after solving the linear system. What we then have to do is to use the constraints to assign to them the values that they should have. This process, called <code>distributing</code> constraints, computes the values of constrained nodes from the values of the unconstrained ones, and requires only a single additional function call that you find at the end of this function:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step6&lt;dim&gt;::solve ()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a>           solver_control (1000, 1e-12);</div>
<div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;&gt;</a>              solver (solver_control);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;&gt;</a> preconditioner;</div>
<div class="line">  preconditioner.<a class="code" href="classPreconditionSSOR.html#aa564d2dbcdcf09c6ceed549f319b5465">initialize</a>(system_matrix, 1.2);</div>
<div class="line"></div>
<div class="line">  solver.solve (system_matrix, solution, system_rhs,</div>
<div class="line">                preconditioner);</div>
<div class="line"></div>
<div class="line">  constraints.<a class="code" href="classConstraintMatrix.html#a7cf6b84c47aa32408f412ae769085bd6">distribute</a> (solution);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Step6refine_grid"></a> </p>
<h4>Step6::refine_grid</h4>
<p>Instead of global refinement, we now use a slightly more elaborate scheme. We will use the <code><a class="el" href="classKellyErrorEstimator.html">KellyErrorEstimator</a></code> class which implements an error estimator for the Laplace equation; it can in principle handle variable coefficients, but we will not use these advanced features, but rather use its most simple form since we are not interested in quantitative results but only in a quick way to generate locally refined grids.</p>
<p>Although the error estimator derived by Kelly et al. was originally developed for the Laplace equation, we have found that it is also well suited to quickly generate locally refined grids for a wide class of problems. Basically, it looks at the jumps of the gradients of the solution over the faces of cells (which is a measure for the second derivatives) and scales it by the size of the cell. It is therefore a measure for the local smoothness of the solution at the place of each cell and it is thus understandable that it yields reasonable grids also for hyperbolic transport problems or the wave equation as well, although these grids are certainly suboptimal compared to approaches specially tailored to the problem. This error estimator may therefore be understood as a quick way to test an adaptive program.</p>
<p>The way the estimator works is to take a <code><a class="el" href="classDoFHandler.html">DoFHandler</a></code> object describing the degrees of freedom and a vector of values for each degree of freedom as input and compute a single indicator value for each active cell of the triangulation (i.e. one value for each of the <code>triangulation.n_active_cells()</code> cells). To do so, it needs two additional pieces of information: a quadrature formula on the faces (i.e. quadrature formula on <code>dim-1</code> dimensional objects. We use a 3-point Gauss rule again, a pick that is consistent and appropriate with the choice bi-quadratic finite element shape functions in this program. (What constitutes a suitable quadrature rule here of course depends on knowledge of the way the error estimator evaluates the solution field. As said above, the jump of the gradient is integrated over each face, which would be a quadratic function on each face for the quadratic elements in use in this example. In fact, however, it is the square of the jump of the gradient, as explained in the documentation of that class, and that is a quartic function, for which a 3 point Gauss formula is sufficient since it integrates polynomials up to order 5 exactly.)</p>
<p>Secondly, the function wants a list of boundaries where we have imposed Neumann value, and the corresponding Neumann values. This information is represented by an object of type <code><a class="el" href="structFunctionMap.html#aa286a6c5e13045f84faabfd7170b1c48">FunctionMap::type</a></code> that is essentially a map from boundary indicators to function objects describing Neumann boundary values (in the present example program, we do not use Neumann boundary values, so this map is empty, and in fact constructed using the default constructor of the map in the place where the function call expects the respective function argument).</p>
<p>The output, as mentioned is a vector of values for all cells. While it may make sense to compute the <em>value</em> of a degree of freedom very accurately, it is usually not helpful to compute the <em>error indicator</em> corresponding to a cell particularly accurately. We therefore typically use a vector of floats instead of a vector of doubles to represent error indicators.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step6&lt;dim&gt;::refine_grid ()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell (triangulation.<a class="code" href="classTriangulation.html#aa21f25016ce1b9d70d2003a128985870">n_active_cells</a>());</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classKellyErrorEstimator.html#ae1f3149bcc7653baa5ef0a2ac88070b9">KellyErrorEstimator&lt;dim&gt;::estimate</a> (dof_handler,</div>
<div class="line">                                      <a class="code" href="classQGauss.html">QGauss&lt;dim-1&gt;</a>(3),</div>
<div class="line">                                      <span class="keyword">typename</span> <a class="code" href="structFunctionMap.html#aa286a6c5e13045f84faabfd7170b1c48">FunctionMap&lt;dim&gt;::type</a>(),</div>
<div class="line">                                      solution,</div>
<div class="line">                                      estimated_error_per_cell);</div>
</div><!-- fragment --><p>The above function returned one error indicator value for each cell in the <code>estimated_error_per_cell</code> array. Refinement is now done as follows: refine those 30 per cent of the cells with the highest error values, and coarsen the 3 per cent of cells with the lowest values.</p>
<p>One can easily verify that if the second number were zero, this would approximately result in a doubling of cells in each step in two space dimensions, since for each of the 30 per cent of cells, four new would be replaced, while the remaining 70 per cent of cells remain untouched. In practice, some more cells are usually produced since it is disallowed that a cell is refined twice while the neighbor cell is not refined; in that case, the neighbor cell would be refined as well.</p>
<p>In many applications, the number of cells to be coarsened would be set to something larger than only three per cent. A non-zero value is useful especially if for some reason the initial (coarse) grid is already rather refined. In that case, it might be necessary to refine it in some regions, while coarsening in some other regions is useful. In our case here, the initial grid is very coarse, so coarsening is only necessary in a few regions where over-refinement may have taken place. Thus a small, non-zero value is appropriate here.</p>
<p>The following function now takes these refinement indicators and flags some cells of the triangulation for refinement or coarsening using the method described above. It is from a class that implements several different algorithms to refine a triangulation based on cell-wise error indicators.</p>
<div class="fragment"><div class="line"><a class="code" href="namespaceGridRefinement.html#a722dd0fd72533bf87367b0ec14e893e0">GridRefinement::refine_and_coarsen_fixed_number</a> (triangulation,</div>
<div class="line">                                                 estimated_error_per_cell,</div>
<div class="line">                                                 0.3, 0.03);</div>
</div><!-- fragment --><p>After the previous function has exited, some cells are flagged for refinement, and some other for coarsening. The refinement or coarsening itself is not performed by now, however, since there are cases where further modifications of these flags is useful. Here, we don't want to do any such thing, so we can tell the triangulation to perform the actions for which the cells are flagged:</p>
<div class="fragment"><div class="line">  triangulation.<a class="code" href="classTriangulation.html#aaedd900205c1879d8d9ef6ffe7d1a554">execute_coarsening_and_refinement</a> ();</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Step6output_results"></a> </p>
<h4>Step6::output_results</h4>
<p>At the end of computations on each grid, and just before we continue the next cycle with mesh refinement, we want to output the results from this cycle.</p>
<p>In the present program, we will not write the solution (except for in the last step, see the next function), but only the meshes that we generated, as a two-dimensional Encapsulated Postscript (EPS) file.</p>
<p>We have already seen in <a class="el" href="step_1.html">step-1</a> how this can be achieved. The only thing we have to change is the generation of the file name, since it should contain the number of the present refinement cycle provided to this function as an argument. The most general way is to use the std::stringstream class as shown in <a class="el" href="step_5.html">step-5</a>, but here's a little hack that makes it simpler if we know that we have less than 10 iterations: assume that the numbers `0' through `9' are represented consecutively in the character set used on your machine (this is in fact the case in all known character sets), then '0'+cycle gives the character corresponding to the present cycle number. Of course, this will only work if the number of cycles is actually less than 10, and rather than waiting for the disaster to happen, we safeguard our little hack with an explicit assertion at the beginning of the function. If this assertion is triggered, i.e. when <code>cycle</code> is larger than or equal to 10, an exception of type <code>ExcNotImplemented</code> is raised, indicating that some functionality is not implemented for this case (the functionality that is missing, of course, is the generation of file names for that case):</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step6&lt;dim&gt;::output_results (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a> (cycle &lt; 10, <a class="code" href="group__Exceptions.html#gac43116aa5c4896cb376bf817ee854e70">ExcNotImplemented</a>());</div>
<div class="line"></div>
<div class="line">  std::string filename = <span class="stringliteral">&quot;grid-&quot;</span>;</div>
<div class="line">  filename += (<span class="charliteral">&#39;0&#39;</span> + cycle);</div>
<div class="line">  filename += <span class="stringliteral">&quot;.eps&quot;</span>;</div>
<div class="line"></div>
<div class="line">  std::ofstream output (filename.c_str());</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classGridOut.html">GridOut</a> grid_out;</div>
<div class="line">  grid_out.<a class="code" href="classGridOut.html#a52add81f6036ad80ecfb215f48e96381">write_eps</a> (triangulation, output);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Step6run"></a> </p>
<h4>Step6::run</h4>
<p>The final function before <code><a class="el" href="group__ParameterGui.html#ga0ddf1224851353fc92bfbff6f499fa97">main()</a></code> is again the main driver of the class, <code>run()</code>. It is similar to the one of <a class="el" href="step_5.html">step-5</a>, except that we generate a file in the program again instead of reading it from disk, in that we adaptively instead of globally refine the mesh, and that we output the solution on the final mesh in the present function.</p>
<p>The first block in the main loop of the function deals with mesh generation. If this is the first cycle of the program, instead of reading the grid from a file on disk as in the previous example, we now again create it using a library function. The domain is again a circle, which is why we have to provide a suitable boundary object as well. We place the center of the circle at the origin and have the radius be one (these are the two hidden arguments to the function, which have default values).</p>
<p>You will notice by looking at the coarse grid that it is of inferior quality than the one which we read from the file in the previous example: the cells are less equally formed. However, using the library function this program works in any space dimension, which was not the case before.</p>
<p>In case we find that this is not the first cycle, we want to refine the grid. Unlike the global refinement employed in the last example program, we now use the adaptive procedure described above.</p>
<p>The rest of the loop looks as before:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step6&lt;dim&gt;::run ()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle=0; cycle&lt;8; ++cycle)</div>
<div class="line">    {</div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">if</span> (cycle == 0)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="namespaceGridGenerator.html#a0a81f736ef95164a9d9bf0f844ac682b">GridGenerator::hyper_ball</a> (triangulation);</div>
<div class="line"></div>
<div class="line">          <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classHyperBallBoundary.html">HyperBallBoundary&lt;dim&gt;</a> boundary;</div>
<div class="line">          triangulation.<a class="code" href="group__boundary.html#ga0509d862f0e07071dcff837bd58fd082">set_boundary</a> (0, boundary);</div>
<div class="line"></div>
<div class="line">          triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a> (1);</div>
<div class="line">        }</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        refine_grid ();</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;   Number of active cells:       &quot;</span></div>
<div class="line">                &lt;&lt; triangulation.<a class="code" href="classTriangulation.html#aa21f25016ce1b9d70d2003a128985870">n_active_cells</a>()</div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">      setup_system ();</div>
<div class="line"></div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span></div>
<div class="line">                &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#a54e7270f2ba6206604f794114b39a2aa">n_dofs</a>()</div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">      assemble_system ();</div>
<div class="line">      solve ();</div>
<div class="line">      output_results (cycle);</div>
<div class="line">    }</div>
</div><!-- fragment --><p>After we have finished computing the solution on the finest mesh, and writing all the grids to disk, we want to also write the actual solution on this final mesh to a file. As already done in one of the previous examples, we use the EPS format for output, and to obtain a reasonable view on the solution, we rescale the z-axis by a factor of four.</p>
<div class="fragment"><div class="line">  <a class="code" href="structDataOutBase_1_1EpsFlags.html">DataOutBase::EpsFlags</a> eps_flags;</div>
<div class="line">  eps_flags.<a class="code" href="structDataOutBase_1_1EpsFlags.html#aae56c32425575726b67b106edef3787b">z_scaling</a> = 4;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#ab62747d458c1415d4bdb5e5b0ea2a68f">set_flags</a> (eps_flags);</div>
<div class="line"></div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a5e63bad650805ce93cd74c6dc3b29b11">attach_dof_handler</a> (dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a59a6b70a4b909e0229a20487dd68cc43">add_data_vector</a> (solution, <span class="stringliteral">&quot;solution&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#ab3d44201acb97fba286a897452236b51">build_patches</a> ();</div>
<div class="line"></div>
<div class="line">  std::ofstream output (<span class="stringliteral">&quot;final-solution.eps&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#a16609dff8ed26b761521930933679b7e">write_eps</a> (output);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a> </p>
<h3>The <code>main</code> function</h3>
<p>The main function is unaltered in its functionality from the previous example, but we have taken a step of additional caution. Sometimes, something goes wrong (such as insufficient disk space upon writing an output file, not enough memory when trying to allocate a vector or a matrix, or if we can't read from or write to a file for whatever reason), and in these cases the library will throw exceptions. Since these are run-time problems, not programming errors that can be fixed once and for all, this kind of exceptions is not switched off in optimized mode, in contrast to the <code>Assert</code> macro which we have used to test against programming errors. If uncaught, these exceptions propagate the call tree up to the <code>main</code> function, and if they are not caught there either, the program is aborted. In many cases, like if there is not enough memory or disk space, we can't do anything but we can at least print some text trying to explain the reason why the program failed. A way to do so is shown in the following. It is certainly useful to write any larger program in this way, and you can do so by more or less copying this function except for the <code>try</code> block that actually encodes the functionality particular to the present application.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__ParameterGui.html#ga0ddf1224851353fc92bfbff6f499fa97">main</a> ()</div>
<div class="line">{</div>
</div><!-- fragment --><p>The general idea behind the layout of this function is as follows: let's try to run the program as we did before...</p>
<div class="fragment"><div class="line"><span class="keywordflow">try</span></div>
<div class="line">  {</div>
<div class="line">    deallog.<a class="code" href="classLogStream.html#a8028e970ad8388596d625ed463894e98">depth_console</a> (0);</div>
<div class="line"></div>
<div class="line">    Step6&lt;2&gt; laplace_problem_2d;</div>
<div class="line">    laplace_problem_2d.run ();</div>
<div class="line">  }</div>
</div><!-- fragment --><p>...and if this should fail, try to gather as much information as possible. Specifically, if the exception that was thrown is an object of a class that is derived from the C++ standard class <code>exception</code>, then we can use the <code>what</code> member function to get a string which describes the reason why the exception was thrown.</p>
<p>The deal.II exception classes are all derived from the standard class, and in particular, the <code>exc.what()</code> function will return approximately the same string as would be generated if the exception was thrown using the <code>Assert</code> macro. You have seen the output of such an exception in the previous example, and you then know that it contains the file and line number of where the exception occurred, and some other information. This is also what the following statements would print.</p>
<p>Apart from this, there isn't much that we can do except exiting the program with an error code (this is what the <code>return 1;</code> does):</p>
<div class="fragment"><div class="line"><span class="keywordflow">catch</span> (std::exception &amp;exc)</div>
<div class="line">  {</div>
<div class="line">    std::cerr &lt;&lt; std::endl &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line">    std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">  }</div>
</div><!-- fragment --><p>If the exception that was thrown somewhere was not an object of a class derived from the standard <code>exception</code> class, then we can't do anything at all. We then simply print an error message and exit.</p>
<div class="fragment"><div class="line"><span class="keywordflow">catch</span> (...)</div>
<div class="line">  {</div>
<div class="line">    std::cerr &lt;&lt; std::endl &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line">    std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">  }</div>
</div><!-- fragment --><p>If we got to this point, there was no exception which propagated up to the main function (there may have been exceptions, but they were caught somewhere in the program or the library). Therefore, the program performed as was expected and we can return without error.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a></p>
<h1>Results</h1>
<p>The output of the program looks as follows: </p>
<div class="fragment"><div class="line">Cycle 0:</div>
<div class="line">   Number of active cells:       20</div>
<div class="line">   Number of degrees of freedom: 89</div>
<div class="line">Cycle 1:</div>
<div class="line">   Number of active cells:       44</div>
<div class="line">   Number of degrees of freedom: 209</div>
<div class="line">Cycle 2:</div>
<div class="line">   Number of active cells:       92</div>
<div class="line">   Number of degrees of freedom: 449</div>
<div class="line">Cycle 3:</div>
<div class="line">   Number of active cells:       200</div>
<div class="line">   Number of degrees of freedom: 961</div>
<div class="line">Cycle 4:</div>
<div class="line">   Number of active cells:       440</div>
<div class="line">   Number of degrees of freedom: 2033</div>
<div class="line">Cycle 5:</div>
<div class="line">   Number of active cells:       932</div>
<div class="line">   Number of degrees of freedom: 4465</div>
<div class="line">Cycle 6:</div>
<div class="line">   Number of active cells:       1916</div>
<div class="line">   Number of degrees of freedom: 9113</div>
<div class="line">Cycle 7:</div>
<div class="line">   Number of active cells:       3884</div>
<div class="line">   Number of degrees of freedom: 18401</div>
</div><!-- fragment --><p>As intended, the number of cells roughly doubles in each cycle. The number of degrees is slightly more than four times the number of cells; one would expect a factor of exactly four in two spatial dimensions on an infinite grid (since the spacing between the degrees of freedom is half the cell width: one additional degree of freedom on each edge and one in the middle of each cell), but it is larger than that factor due to the finite size of the mesh and due to additional degrees of freedom which are introduced by hanging nodes and local refinement.</p>
<p>The final solution, as written by the program at the end of the <code>run()</code> function, looks as follows:</p>
<div class="image">
<img src="images/step-6.solution.png" />
</div>
<p>In each cycle, the program furthermore writes the grid in EPS format. These are shown in the following:</p>
<table  width="100%">
<tr>
<td><div class="image">
<img src="images/step-6.grid-0.png" />
</div>
  </td><td><div class="image">
<img src="images/step-6.grid-1.png" />
</div>
  <p class="endtd"></p>
</td></tr>
<tr>
<td><div class="image">
<img src="images/step-6.grid-2.png" />
</div>
  </td><td><div class="image">
<img src="images/step-6.grid-3.png" />
</div>
  <p class="endtd"></p>
</td></tr>
<tr>
<td><div class="image">
<img src="images/step-6.grid-4.png" />
</div>
  </td><td><div class="image">
<img src="images/step-6.grid-5.png" />
</div>
  <p class="endtd"></p>
</td></tr>
<tr>
<td><div class="image">
<img src="images/step-6.grid-6.png" />
</div>
  </td><td><div class="image">
<img src="images/step-6.grid-7.png" />
</div>
   </td></tr>
</table>
<p>It is clearly visible that the region where the solution has a kink, i.e. the circle at radial distance 0.5 from the center, is refined most. Furthermore, the central region where the solution is very smooth and almost flat, is almost not refined at all, but this results from the fact that we did not take into account that the coefficient is large there. The region outside is refined rather randomly, since the second derivative is constant there and refinement is therefore mostly based on the size of the cells and their deviation from the optimal square.</p>
<p>For completeness, we show what happens if the code we commented about in the destructor of the <code>Step6</code> class is omitted from this example.</p>
<div class="fragment"><div class="line">--------------------------------------------------------</div>
<div class="line">An error occurred in line &lt;79&gt; of file &lt;source/subscriptor.cc&gt; in <span class="keyword">function</span></div>
<div class="line">    <span class="keyword">virtual</span> <a class="code" href="classSubscriptor.html#a6c6c557e06110d2127fa6459119e94af">Subscriptor::~Subscriptor</a>()</div>
<div class="line">The violated condition was:</div>
<div class="line">    counter == 0</div>
<div class="line">The name and call sequence of the exception was:</div>
<div class="line">    ExcInUse(counter, object_info-&gt;name(), infostring)</div>
<div class="line">Additional Information:</div>
<div class="line">Object of class 4FE_QILi2EE is still used by 1 other objects.</div>
<div class="line">  from Subscriber 10DoFHandlerILi2EE</div>
<div class="line"></div>
<div class="line">Stacktrace:</div>
<div class="line">-----------</div>
<div class="line"><span class="preprocessor">#0  /u/bangerth/p/deal.II/1/deal.II/lib/libbase.g.so: Subscriptor::~Subscriptor()</span></div>
<div class="line"><span class="preprocessor">#1  /u/bangerth/p/deal.II/1/deal.II/lib/libdeal_II_2d.g.so: FiniteElement&lt;2&gt;::~FiniteElement()</span></div>
<div class="line"><span class="preprocessor">#2  ./step-6: FE_Poly&lt;TensorProductPolynomials&lt;2&gt;, 2&gt;::~FE_Poly()</span></div>
<div class="line"><span class="preprocessor">#3  ./step-6: FE_Q&lt;2&gt;::~FE_Q()</span></div>
<div class="line"><span class="preprocessor">#4  ./step-6: Step6&lt;2&gt;::~Step6()</span></div>
<div class="line"><span class="preprocessor">#5  ./step-6: main</span></div>
<div class="line">--------------------------------------------------------</div>
<div class="line">make: *** [run] Aborted</div>
</div><!-- fragment --><p>From the above error message, we conclude that an object of type <code>10DoFHandlerILi2EE</code> is still using the object of type <code>4FE_QILi2EE</code>. These are of course <a href="http://en.wikipedia.org/wiki/Name_mangling">"mangled" names</a> for <code><a class="el" href="classDoFHandler.html">DoFHandler</a></code> and <code><a class="el" href="classFE__Q.html">FE_Q</a></code>. The mangling works as follows: the first number indicates the number of characters of the template class, i.e. 10 for <code><a class="el" href="classDoFHandler.html">DoFHandler</a></code> and 4 for<code><a class="el" href="classFE__Q.html">FE_Q</a></code>; the rest of the text is then template arguments. From this we can already glean a little bit who's the culprit here, and who the victim: The one object that still uses the finite element is the <code>dof_handler</code> object.</p>
<p>The stacktrace gives an indication of where the problem happened. We see that the exception was triggered in the destructor of the <code><a class="el" href="classFiniteElement.html">FiniteElement</a></code> class that was called through a few more functions from the destructor of the <code>Step6</code> class, exactly where we have commented out the call to <code><a class="el" href="classDoFHandler.html#a78fda065d6f58e554a3335ea9b5b482e">DoFHandler::clear()</a></code>.</p>
<p><a class="anchor" id="extensions"></a> <a class="anchor" id="Possibilitiesforextensions"></a></p>
<h3>Possibilities for extensions</h3>
<p>One thing that is always worth playing around with if one solves problems of appreciable size (much bigger than the one we have here) is to try different solvers or preconditioners. In the current case, the linear system is symmetric and positive definite, which makes the CG algorithm pretty much the canonical choice for solving. However, the SSOR preconditioner we use in the <code>solve()</code> function is up for grabs.</p>
<p>In deal.II, it is relatively simple to change the preconditioner. For example, by changing the existing lines of code </p>
<div class="fragment"><div class="line"><a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;&gt;</a> preconditioner;</div>
<div class="line">preconditioner.<a class="code" href="classPreconditionSSOR.html#aa564d2dbcdcf09c6ceed549f319b5465">initialize</a>(system_matrix, 1.2);</div>
</div><!-- fragment --><p> into </p>
<div class="fragment"><div class="line"><a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;&gt;</a> preconditioner;</div>
<div class="line">preconditioner.<a class="code" href="classPreconditionSSOR.html#aa564d2dbcdcf09c6ceed549f319b5465">initialize</a>(system_matrix, 1.0);</div>
</div><!-- fragment --><p> we can try out different relaxation parameters for SSOR. By using (you have to also add the header file <code><a class="el" href="sparse__ilu_8h_source.html">lac/sparse_ilu.h</a></code> to the include list at the top of the file) </p>
<div class="fragment"><div class="line"><a class="code" href="classPreconditionJacobi.html">PreconditionJacobi&lt;&gt;</a> preconditioner;</div>
<div class="line">preconditioner.<a class="code" href="classPreconditionRelaxation.html#a9f579ae7ac5e8318d2ed3db891f087ab">initialize</a>(system_matrix);</div>
</div><!-- fragment --><p> we can use Jacobi as a preconditioner. And by using </p>
<div class="fragment"><div class="line"><a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a> preconditioner;</div>
<div class="line">preconditioner.<a class="code" href="classSparseILU.html#a1f706d230cbc96643a666d07e32353ae">initialize</a>(system_matrix);</div>
</div><!-- fragment --><p> we can use a very simply incomplete LU decomposition without any thresholding or strengthening of the diagonal.</p>
<p>Using these various different preconditioners, we can compare the number of CG iterations needed (available through the <code>solver_control.last_step()</code> call, see <a class="el" href="step_4.html">step-4</a>) as well as CPU time needed (using the <a class="el" href="classTimer.html">Timer</a> class, discussed, for example, in <a class="el" href="step_12.html">step-12</a>) and get the following results (left: iterations; right: CPU time):</p>
<table  width="60%" align="center">
<tr>
<td align="center"><div class="image">
<img src="images/step-6.q2.dofs_vs_iterations.png" />
</div>
 <p class="endtd"></p>
</td><td align="center"><div class="image">
<img src="images/step-6.q2.dofs_vs_time.png" />
</div>
   </td></tr>
</table>
<p>As we can see, all preconditioners behave pretty much the same on this simple problem, with the number of iterations growing like <img class="formulaInl" alt="${\cal O}(N^{1/2})$" src="form_1776.png"/> and because each iteration requires around <img class="formulaInl" alt="${\cal O}(N)$" src="form_138.png"/> operations the total CPU time grows like <img class="formulaInl" alt="${\cal O}(N^{3/2})$" src="form_1777.png"/> (for the few smallest meshes, the CPU time is so small that it doesn't record). Note that even though it is the simplest method, Jacobi is the fastest for this problem.</p>
<p>The situation changes slightly when the finite element is not a bi-quadratic one as set in the constructor of this program, but a bi-linear one. If one makes this change, the results are as follows:</p>
<table  width="60%" align="center">
<tr>
<td align="center"><div class="image">
<img src="images/step-6.q1.dofs_vs_iterations.png" />
</div>
 <p class="endtd"></p>
</td><td align="center"><div class="image">
<img src="images/step-6.q1.dofs_vs_time.png" />
</div>
   </td></tr>
</table>
<p>In other words, while the increase in iterations and CPU time is as before, Jacobi is now the method that requires the most iterations; it is still the fastest one, however, owing to the simplicity of the operations it has to perform.</p>
<p>The message to take away from this is not that simplicity in preconditioners is always best. While this may be true for the current problem, it definitely is not once we move to more complicated problems (elasticity or Stokes, for examples <a class="el" href="step_8.html">step-8</a> or <a class="el" href="step_22.html">step-22</a>). Secondly, all of these preconditioners still lead to an increase in the number of iterations as the number <img class="formulaInl" alt="$N$" src="form_139.png"/> of degrees of freedom grows, for example <img class="formulaInl" alt="${\cal O}(N^\alpha)$" src="form_1778.png"/>; this, in turn, leads to a total growth in effort as <img class="formulaInl" alt="${\cal O}(N^{1+\alpha})$" src="form_1779.png"/> since each iteration takes <img class="formulaInl" alt="${\cal O}(N)$" src="form_138.png"/> work. This behavior is undesirable, we would really like to solve linear systems with <img class="formulaInl" alt="$N$" src="form_139.png"/> unknowns in a total of <img class="formulaInl" alt="${\cal O}(N)$" src="form_138.png"/> work; there is a class of preconditioners that can achieve this, namely geometric (<a class="el" href="step_16.html">step-16</a>) or algebraic (<a class="el" href="step_31.html">step-31</a>) multigrid preconditioners. They are, however, significantly more complex than the preconditioners outlined above. Finally, the last message to take home is that today (in 2008), linear systems with 100,000 unknowns are easily solved on a desktop machine in well under 10 seconds, making the solution of relatively simple 2d problems even to very high accuracy not that big a task as it used to be even in the recent past. Of course, the situation for 3d problems is entirely different.</p>
<p><a class="anchor" id="PlainProg"></a> </p>
<h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * @f$Id: @ref step_6 &quot;step-6&quot;.cc 30526 2013-08-29 20:06:27Z felix.gruber @f$</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2000 - 2013 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE at</span></div>
<div class="line"><span class="comment"> * the top level of the deal.II distribution.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Author: Wolfgang Bangerth, University of Heidelberg, 2000</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/base/quadrature_lib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/base/function.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/base/logstream.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/vector.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/full_matrix.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/sparse_matrix.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/compressed_sparsity_pattern.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/solver_cg.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/precondition.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_handler.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/grid_generator.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria_accessor.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria_iterator.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/tria_boundary_lib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_accessor.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/dofs/dof_tools.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/fe/fe_values.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/vector_tools.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/matrix_tools.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/data_out.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/fe/fe_q.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/grid_out.h&gt;</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/lac/constraint_matrix.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/grid/grid_refinement.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;deal.II/numerics/error_estimator.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">using namespace </span>dealii;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>Step6</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  Step6 ();</div>
<div class="line">  ~Step6 ();</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">void</span> run ();</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> setup_system ();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_system ();</div>
<div class="line">  <span class="keywordtype">void</span> solve ();</div>
<div class="line">  <span class="keywordtype">void</span> refine_grid ();</div>
<div class="line">  <span class="keywordtype">void</span> output_results (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle) <span class="keyword">const</span>;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>   triangulation;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>      dof_handler;</div>
<div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>            fe;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classConstraintMatrix.html">ConstraintMatrix</a>     constraints;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern;</div>
<div class="line">  <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>       solution;</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>       system_rhs;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>Coefficient : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  Coefficient () : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;() {}</div>
<div class="line"></div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> value (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>   &amp;p,</div>
<div class="line">                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  component = 0) <span class="keyword">const</span>;</div>
<div class="line"></div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> value_list (<span class="keyword">const</span> std::vector&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &gt; &amp;points,</div>
<div class="line">                           std::vector&lt;double&gt;            &amp;values,</div>
<div class="line">                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>              component = 0) <span class="keyword">const</span>;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> Coefficient&lt;dim&gt;::value (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div>
<div class="line">                                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">if</span> (p.<a class="code" href="classPoint.html#ad46f55479010282e242b1d8e427285e8">square</a>() &lt; 0.5*0.5)</div>
<div class="line">    <span class="keywordflow">return</span> 20;</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Coefficient&lt;dim&gt;::value_list (<span class="keyword">const</span> std::vector&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &gt; &amp;points,</div>
<div class="line">                                   std::vector&lt;double&gt;            &amp;values,</div>
<div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>              component)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_points = points.size();</div>
<div class="line"></div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a> (values.size() == n_points,</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga325fd73751a9373f1b901962daeb2ea7">ExcDimensionMismatch</a> (values.size(), n_points));</div>
<div class="line"></div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a> (component == 0,</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga3f3f87a5613ac8b4e64ecd458dea8e9b">ExcIndexRange</a> (component, 0, 1));</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;n_points; ++i)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (points[i].square() &lt; 0.5*0.5)</div>
<div class="line">        values[i] = 20;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        values[i] = 1;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">Step6&lt;dim&gt;::Step6 ()</div>
<div class="line">  :</div>
<div class="line">  dof_handler (triangulation),</div>
<div class="line">  fe (2)</div>
<div class="line">{}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">Step6&lt;dim&gt;::~Step6 ()</div>
<div class="line">{</div>
<div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a78fda065d6f58e554a3335ea9b5b482e">clear</a> ();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step6&lt;dim&gt;::setup_system ()</div>
<div class="line">{</div>
<div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#afcfcc3b473f444f50d206ae62dfe3694">distribute_dofs</a> (fe);</div>
<div class="line"></div>
<div class="line">  solution.<a class="code" href="classVector.html#ac3adfcf8cf35943558fc27ef989b7263">reinit</a> (dof_handler.<a class="code" href="classDoFHandler.html#a54e7270f2ba6206604f794114b39a2aa">n_dofs</a>());</div>
<div class="line">  system_rhs.reinit (dof_handler.<a class="code" href="classDoFHandler.html#a54e7270f2ba6206604f794114b39a2aa">n_dofs</a>());</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  constraints.<a class="code" href="classConstraintMatrix.html#a24120d0331183f9a63cbe41493a19f6b">clear</a> ();</div>
<div class="line">  <a class="code" href="group__constraints.html#gabe9d21d4bb33ce556a6e6e80c2bf4b41">DoFTools::make_hanging_node_constraints</a> (dof_handler,</div>
<div class="line">                                           constraints);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#a199f38e07822b47e5b5957c21ce35d1b">VectorTools::interpolate_boundary_values</a> (dof_handler,</div>
<div class="line">                                            0,</div>
<div class="line">                                            <a class="code" href="classZeroFunction.html">ZeroFunction&lt;dim&gt;</a>(),</div>
<div class="line">                                            constraints);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  constraints.<a class="code" href="classConstraintMatrix.html#a8056d07faa2a7ed3f158c1b42d56abc8">close</a> ();</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classCompressedSparsityPattern.html">CompressedSparsityPattern</a> c_sparsity(dof_handler.<a class="code" href="classDoFHandler.html#a54e7270f2ba6206604f794114b39a2aa">n_dofs</a>());</div>
<div class="line">  <a class="code" href="group__constraints.html#gab627b1d4845c9526521dbd1be83469dc">DoFTools::make_sparsity_pattern</a>(dof_handler,</div>
<div class="line">                                  c_sparsity,</div>
<div class="line">                                  constraints,</div>
<div class="line">                                  <span class="comment">/*keep_constrained_dofs = */</span> <span class="keyword">false</span>);</div>
<div class="line"></div>
<div class="line">  sparsity_pattern.<a class="code" href="classSparsityPattern.html#aafd93c00be64a9ab832c68aefaecace6">copy_from</a>(c_sparsity);</div>
<div class="line"></div>
<div class="line">  system_matrix.reinit (sparsity_pattern);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step6&lt;dim&gt;::assemble_system ()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(3);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values (fe, quadrature_formula,</div>
<div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>    |  <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>  |  <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"></div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#a4d64837b1d374e9c46f07af8f094b29b">size</a>();</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>   cell_matrix (dofs_per_cell, dofs_per_cell);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>       cell_rhs (dofs_per_cell);</div>
<div class="line"></div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; local_dof_indices (dofs_per_cell);</div>
<div class="line"></div>
<div class="line">  <span class="keyword">const</span> Coefficient&lt;dim&gt; coefficient;</div>
<div class="line">  std::vector&lt;double&gt;    coefficient_values (n_q_points);</div>
<div class="line"></div>
<div class="line">  <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a></div>
<div class="line">  cell = dof_handler.<a class="code" href="classDoFHandler.html#a6f2aa9c61385cbb749ed3d2e7bfe3de1">begin_active</a>(),</div>
<div class="line">  endc = dof_handler.<a class="code" href="classDoFHandler.html#abf64c3734383b6fb1bed4888935f2edf">end</a>();</div>
<div class="line">  <span class="keywordflow">for</span> (; cell!=endc; ++cell)</div>
<div class="line">    {</div>
<div class="line">      cell_matrix = 0;</div>
<div class="line">      cell_rhs = 0;</div>
<div class="line"></div>
<div class="line">      fe_values.<a class="code" href="classFEValues.html#afde502903642c57ade24dfcebf5c1650">reinit</a> (cell);</div>
<div class="line"></div>
<div class="line">      coefficient.value_list (fe_values.<a class="code" href="classFEValuesBase.html#a5f8732ebe2d3c6746f6de26a79cb1e45">get_quadrature_points</a>(),</div>
<div class="line">                              coefficient_values);</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point=0; q_point&lt;n_q_points; ++q_point)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;dofs_per_cell; ++i)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j=0; j&lt;dofs_per_cell; ++j)</div>
<div class="line">              cell_matrix(i,j) += (coefficient_values[q_point] *</div>
<div class="line">                                   fe_values.<a class="code" href="classFEValuesBase.html#ac4cee7628c2903a89c5c399fddeb00a5">shape_grad</a>(i,q_point) *</div>
<div class="line">                                   fe_values.<a class="code" href="classFEValuesBase.html#ac4cee7628c2903a89c5c399fddeb00a5">shape_grad</a>(j,q_point) *</div>
<div class="line">                                   fe_values.<a class="code" href="classFEValuesBase.html#ad097580a2f71878695096cc73b271b9d">JxW</a>(q_point));</div>
<div class="line"></div>
<div class="line">            cell_rhs(i) += (fe_values.<a class="code" href="classFEValuesBase.html#abe4de48ff59778bb82a0ec13037804aa">shape_value</a>(i,q_point) *</div>
<div class="line">                            1.0 *</div>
<div class="line">                            fe_values.<a class="code" href="classFEValuesBase.html#ad097580a2f71878695096cc73b271b9d">JxW</a>(q_point));</div>
<div class="line">          }</div>
<div class="line"></div>
<div class="line">      cell-&gt;get_dof_indices (local_dof_indices);</div>
<div class="line">      constraints.<a class="code" href="classConstraintMatrix.html#aa9f3612a8fc51eafa34252bb436e8ae4">distribute_local_to_global</a>(cell_matrix,</div>
<div class="line">                                             cell_rhs,</div>
<div class="line">                                             local_dof_indices,</div>
<div class="line">                                             system_matrix, system_rhs);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step6&lt;dim&gt;::solve ()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a>           solver_control (1000, 1e-12);</div>
<div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;&gt;</a>              solver (solver_control);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;&gt;</a> preconditioner;</div>
<div class="line">  preconditioner.<a class="code" href="classPreconditionSSOR.html#aa564d2dbcdcf09c6ceed549f319b5465">initialize</a>(system_matrix, 1.2);</div>
<div class="line"></div>
<div class="line">  solver.solve (system_matrix, solution, system_rhs,</div>
<div class="line">                preconditioner);</div>
<div class="line"></div>
<div class="line">  constraints.<a class="code" href="classConstraintMatrix.html#a7cf6b84c47aa32408f412ae769085bd6">distribute</a> (solution);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step6&lt;dim&gt;::refine_grid ()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell (triangulation.<a class="code" href="classTriangulation.html#aa21f25016ce1b9d70d2003a128985870">n_active_cells</a>());</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classKellyErrorEstimator.html#ae1f3149bcc7653baa5ef0a2ac88070b9">KellyErrorEstimator&lt;dim&gt;::estimate</a> (dof_handler,</div>
<div class="line">                                      <a class="code" href="classQGauss.html">QGauss&lt;dim-1&gt;</a>(3),</div>
<div class="line">                                      <span class="keyword">typename</span> <a class="code" href="structFunctionMap.html#aa286a6c5e13045f84faabfd7170b1c48">FunctionMap&lt;dim&gt;::type</a>(),</div>
<div class="line">                                      solution,</div>
<div class="line">                                      estimated_error_per_cell);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="namespaceGridRefinement.html#a722dd0fd72533bf87367b0ec14e893e0">GridRefinement::refine_and_coarsen_fixed_number</a> (triangulation,</div>
<div class="line">                                                   estimated_error_per_cell,</div>
<div class="line">                                                   0.3, 0.03);</div>
<div class="line"></div>
<div class="line">  triangulation.<a class="code" href="classTriangulation.html#aaedd900205c1879d8d9ef6ffe7d1a554">execute_coarsening_and_refinement</a> ();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step6&lt;dim&gt;::output_results (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a> (cycle &lt; 10, <a class="code" href="group__Exceptions.html#gac43116aa5c4896cb376bf817ee854e70">ExcNotImplemented</a>());</div>
<div class="line"></div>
<div class="line">  std::string filename = <span class="stringliteral">&quot;grid-&quot;</span>;</div>
<div class="line">  filename += (<span class="charliteral">&#39;0&#39;</span> + cycle);</div>
<div class="line">  filename += <span class="stringliteral">&quot;.eps&quot;</span>;</div>
<div class="line"></div>
<div class="line">  std::ofstream output (filename.c_str());</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classGridOut.html">GridOut</a> grid_out;</div>
<div class="line">  grid_out.<a class="code" href="classGridOut.html#a52add81f6036ad80ecfb215f48e96381">write_eps</a> (triangulation, output);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> Step6&lt;dim&gt;::run ()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle=0; cycle&lt;8; ++cycle)</div>
<div class="line">    {</div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">if</span> (cycle == 0)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="namespaceGridGenerator.html#a0a81f736ef95164a9d9bf0f844ac682b">GridGenerator::hyper_ball</a> (triangulation);</div>
<div class="line"></div>
<div class="line">          <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classHyperBallBoundary.html">HyperBallBoundary&lt;dim&gt;</a> boundary;</div>
<div class="line">          triangulation.<a class="code" href="group__boundary.html#ga0509d862f0e07071dcff837bd58fd082">set_boundary</a> (0, boundary);</div>
<div class="line"></div>
<div class="line">          triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a> (1);</div>
<div class="line">        }</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        refine_grid ();</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;   Number of active cells:       &quot;</span></div>
<div class="line">                &lt;&lt; triangulation.<a class="code" href="classTriangulation.html#aa21f25016ce1b9d70d2003a128985870">n_active_cells</a>()</div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">      setup_system ();</div>
<div class="line"></div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span></div>
<div class="line">                &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#a54e7270f2ba6206604f794114b39a2aa">n_dofs</a>()</div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">      assemble_system ();</div>
<div class="line">      solve ();</div>
<div class="line">      output_results (cycle);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">  <a class="code" href="structDataOutBase_1_1EpsFlags.html">DataOutBase::EpsFlags</a> eps_flags;</div>
<div class="line">  eps_flags.<a class="code" href="structDataOutBase_1_1EpsFlags.html#aae56c32425575726b67b106edef3787b">z_scaling</a> = 4;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#ab62747d458c1415d4bdb5e5b0ea2a68f">set_flags</a> (eps_flags);</div>
<div class="line"></div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a5e63bad650805ce93cd74c6dc3b29b11">attach_dof_handler</a> (dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a59a6b70a4b909e0229a20487dd68cc43">add_data_vector</a> (solution, <span class="stringliteral">&quot;solution&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#ab3d44201acb97fba286a897452236b51">build_patches</a> ();</div>
<div class="line"></div>
<div class="line">  std::ofstream output (<span class="stringliteral">&quot;final-solution.eps&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#a16609dff8ed26b761521930933679b7e">write_eps</a> (output);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="group__ParameterGui.html#ga0ddf1224851353fc92bfbff6f499fa97">main</a> ()</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      deallog.<a class="code" href="classLogStream.html#a8028e970ad8388596d625ed463894e98">depth_console</a> (0);</div>
<div class="line"></div>
<div class="line">      Step6&lt;2&gt; laplace_problem_2d;</div>
<div class="line">      laplace_problem_2d.run ();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.6-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Jan 27 2014 15:26:18 for The deal.II Library by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
